<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片智能助手 - 技能选择</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-app {
            width: 1200px;
            height: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* 登录模态框样式 */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-modal.active {
            display: flex;
        }

        .login-container {
            width: 400px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        .close-login-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            z-index: 10;
        }

        .close-login-btn:hover {
            background: #e9ecef;
            color: #495057;
            transform: rotate(90deg);
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .login-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .login-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-body {
            padding: 30px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .login-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .login-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: #667eea;
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .social-login {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }

        .social-login::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #eee;
            z-index: 1;
        }

        .social-login span {
            background: white;
            padding: 0 15px;
            color: #777;
            font-size: 14px;
            position: relative;
            z-index: 2;
        }

        .social-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .social-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .social-btn.qq {
            background: #12B7F5;
        }

        .social-btn.wechat {
            background: #09BB07;
        }

        .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .register-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        /* 侧边栏 */
        .sidebar {
            width: 280px;
            background: #2d3748;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .user-profile {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #4a5568;
            cursor: pointer;
            position: relative;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-status {
            font-size: 12px;
            color: #a0aec0;
        }

        /* 用户下拉菜单 */
        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: hidden;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 20px;
            color: #2d3748;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }

        .user-dropdown-item:hover {
            background-color: #f7fafc;
        }

        .user-dropdown-item i {
            width: 20px;
            text-align: center;
        }

        .user-dropdown-item.vip {
            color: #d4af37;
            font-weight: 600;
        }

        .user-dropdown-item.logout {
            color: #e53e3e;
        }

        .new-chat-btn {
            margin: 20px;
            padding: 15px;
            background: #4a5568;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            background: #5a6578;
        }

        .new-chat-btn i {
            margin-right: 10px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .history-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            border-left: 3px solid transparent;
            position: relative;
        }

        .history-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .history-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #4a5568;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .history-info {
            flex: 1;
            min-width: 0;
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-preview {
            font-size: 12px;
            color: #a0aec0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-chat-btn {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: rgba(245, 101, 101, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .delete-chat-btn:hover {
            background: #f56565;
            transform: translateY(-50%) scale(1.1);
            opacity: 1;
        }

        /* 主聊天区域 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f7fafc;
        }

        .chat-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .chat-status {
            font-size: 13px;
            color: #718096;
        }

        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f7fafc;
        }

        .message {
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 15px;
        }

        .received .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .sent .message-avatar {
            background: #e2e8f0;
            color: #718096;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
        }

        .received .message-content {
            background: white;
            border-top-left-radius: 5px;
        }

        .sent .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-top-right-radius: 5px;
        }

        .message-text {
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            object-fit: cover;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        /* 输入区域 */
        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .upload-image-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #f7fafc;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .upload-image-btn:hover {
            background: #edf2f7;
            color: #4a5568;
        }

        .message-input-container {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 15px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            background: #f7fafc;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .image-input {
            display: none;
        }

        /* 图片缩略图样式 */
        .image-thumbnail {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .image-thumbnail:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-thumbnail .delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-thumbnail:hover .delete-btn {
            opacity: 1;
        }

        /* 底部操作区域 */
        .bottom-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 技能选择器 */
        .skill-selector {
            position: relative;
            display: inline-block;
        }

        .skill-selector-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .skill-selector-btn:hover {
            background: #e9ecef;
        }

        .skill-selector-btn.active {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        .skill-selector-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .skill-selector-menu.show {
            display: block;
        }

        .skill-category {
            padding: 10px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .skill-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            padding: 10px;
        }

        .skill-item {
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            text-align: center;
        }

        .skill-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .skill-item.active {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        .current-skill-indicator {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
            font-weight: normal;
        }

        .current-skill-indicator span {
            font-weight: 600;
            color: #1565c0;
        }

        .tool-actions {
            display: flex;
            gap: 5px;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            color: #a0aec0;
            margin-top: 50%;
            transform: translateY(-50%);
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-state .hint {
            font-size: 14px;
            opacity: 0.7;
        }

        /* 图片预览模态框 */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .image-preview-modal.active {
            display: flex;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            overflow: hidden;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        /* VIP积分模态框 */
        .vip-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .vip-modal.active {
            display: flex;
        }

        .vip-container {
            width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .vip-header {
            background: linear-gradient(135deg, #d4af37 0%, #f7ef8a 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }

        .close-vip-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }

        .close-vip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .vip-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .vip-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .vip-body {
            padding: 30px;
        }

        .vip-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .vip-level {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vip-badge {
            background: #d4af37;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .vip-points {
            font-size: 24px;
            font-weight: 700;
            color: #d4af37;
        }

        .vip-features {
            margin-bottom: 20px;
        }

        .vip-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 0;
        }

        .vip-feature i {
            color: #d4af37;
        }

        .vip-actions {
            display: flex;
            gap: 10px;
        }

        .vip-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .vip-action-btn.primary {
            background: #d4af37;
            color: white;
        }

        .vip-action-btn.secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .vip-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        /* 处理指示器 */
        .processing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .processing-dots {
            display: flex;
            gap: 4px;
        }

        .processing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #667eea;
            animation: processing 1.5s infinite;
        }

        .processing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .processing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes processing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
<!-- 登录模态框 -->
<div class="login-modal" id="loginModal">
    <div class="login-container">
        <!-- 关闭按钮 -->
        <button class="close-login-btn" id="closeLoginBtn">
            <i class="fas fa-times"></i>
        </button>

        <div class="login-header">
            <h2>欢迎使用图片智能助手</h2>
            <p>请登录您的账户以继续使用</p>
        </div>
        <div class="login-body">
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">登录</div>
                <div class="login-tab" data-tab="register">注册</div>
            </div>

            <!-- 登录表单 -->
            <div class="login-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">用户名</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="请输入密码">
                </div>
                <button class="login-btn" id="loginBtn">登录</button>

                <div class="social-login">
                    <span>或使用以下方式登录</span>
                    <div class="social-buttons">
                        <div class="social-btn qq" id="qqLoginBtn">
                            <i class="fab fa-qq"></i>
                        </div>
                        <div class="social-btn wechat" id="wechatLoginBtn">
                            <i class="fab fa-weixin"></i>
                        </div>
                    </div>
                </div>

                <div class="register-link">
                    还没有账户？<a href="#" id="goToRegister">立即注册</a>
                </div>
            </div>

            <!-- 注册表单 -->
            <div class="login-form" id="registerForm">
                <div class="form-group">
                    <label for="registerUsername">用户名</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="registerEmail">邮箱</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label for="registerPassword">密码</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="请输入密码">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">确认密码</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="请再次输入密码">
                </div>
                <button class="login-btn" id="registerBtn">注册</button>

                <div class="register-link">
                    已有账户？<a href="#" id="goToLogin">立即登录</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- VIP积分模态框 -->
<div class="vip-modal" id="vipModal">
    <div class="vip-container">
        <div class="vip-header">
            <button class="close-vip-btn" id="closeVipBtn">
                <i class="fas fa-times"></i>
            </button>
            <h2>VIP会员中心</h2>
            <p>享受更多专属特权</p>
        </div>
        <div class="vip-body">
            <div class="vip-info">
                <div class="vip-level">
                    <div class="vip-badge">VIP会员</div>
                    <div id="vipLevelName">黄金会员</div>
                </div>
                <div class="vip-points" id="vipPoints">1,250</div>
            </div>
            <div class="vip-features">
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>无限制使用所有AI技能</span>
                </div>
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>优先处理您的请求</span>
                </div>
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>支持高清图片处理</span>
                </div>
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>专属客服支持</span>
                </div>
            </div>
            <div class="vip-actions">
                <button class="vip-action-btn primary" id="rechargeBtn">
                    <i class="fas fa-coins"></i> 充值积分
                </button>
                <button class="vip-action-btn secondary" id="vipHistoryBtn">
                    <i class="fas fa-history"></i> 积分记录
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 图片预览模态框 -->
<div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-content">
        <img id="previewImage" src="" alt="预览图片">
    </div>
</div>

<div class="chat-app">
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="user-profile" id="userProfile">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-name" id="userName">未登录</div>
            <div class="user-status" id="userStatus">点击登录</div>

            <!-- 用户下拉菜单 -->
            <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-item vip" id="vipOption">
                    <i class="fas fa-crown"></i>
                    <span>VIP积分</span>
                </div>
                <div class="user-dropdown-item logout" id="logoutOption">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>退出登录</span>
                </div>
            </div>
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i>
            <span>新建对话</span>
        </button>

        <div class="chat-history" id="chatHistory">
            <!-- 聊天历史会动态加载 -->
        </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chat-info">
                <div class="chat-name">豆包智能助手</div>
                <div class="chat-status">在线 · 选择一个技能开始对话</div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <p>开始与豆包对话吧！</p>
                <div class="hint">选择一个技能，然后输入您的内容</div>
            </div>
        </div>

        <div class="input-area">
            <!-- 图片缩略图容器 -->
            <div class="input-container">
                <div class="input-actions" id="inputActions">
                    <!-- 上传图片按钮 -->
                    <button class="upload-image-btn" id="uploadImageButton" title="上传图片">
                        <i class="fas fa-image"></i>
                    </button>
                    <!-- 图片缩略图会动态添加到这里 -->
                </div>

                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="请先选择一个技能，然后输入内容"></textarea>
                </div>

                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>

                <input type="file" id="imageInput" class="image-input" accept="image/*" multiple>
            </div>

            <!-- 底部操作区域 -->
            <div class="bottom-actions">
                <div class="skill-selector" id="skillSelector">
                    <button class="skill-selector-btn" id="skillSelectorBtn">
                        <i class="fas fa-magic"></i>
                        <span>选择技能</span>
                        <div class="current-skill-indicator" id="currentSkillIndicator"></div>
                    </button>
                    <div class="skill-selector-menu" id="skillSelectorMenu">
                        <div class="skill-category">文本处理</div>
                        <div class="skill-items" id="textSkills">
                            <!-- 文本处理技能会动态添加 -->
                        </div>

                        <div class="skill-category">代码相关</div>
                        <div class="skill-items" id="codeSkills">
                            <!-- 代码相关技能会动态添加 -->
                        </div>

                        <div class="skill-category">高级功能</div>
                        <div class="skill-items" id="advancedSkills">
                            <!-- 高级功能技能会动态添加 -->
                        </div>
                    </div>
                </div>

                <div class="tool-actions">
                    <button class="tool-btn" title="剪刀">
                        <i class="fas fa-cut"></i>
                    </button>
                    <button class="tool-btn" title="麦克风">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="tool-btn" title="发送">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 配置后端API地址
    const API_BASE_URL = '/api'; // 请替换为实际的后端API地址

    // 存储聊天数据
    let chatSessions = {};
    let currentChatId = null;
    let pendingImages = [];
    let currentSkill = null;
    let allSkills = [];
    let isProcessing = false;
    let isLoggedIn = false;
    let currentUser = null;
    let vipPoints = 1250; // 初始VIP积分

    // API请求函数
    async function apiRequest(endpoint, options = {}) {
        try {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 检查响应内容类型
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            } else if (contentType && contentType.includes('image/')) {
                // 处理图片响应
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        resolve({
                            success: true,
                            data: {
                                id: 'img_' + Date.now(),
                                type: 'AI',
                                content: '',
                                imageData: reader.result,
                                timestamp: new Date().toISOString()
                            }
                        });
                    };
                    reader.readAsDataURL(blob);
                });
            } else {
                // 处理文本响应
                const text = await response.text();
                return { success: true, data: text };
            }
        } catch (error) {
            console.error('API请求失败:', error);
            throw error;
        }
    }


    // 初始化应用
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
    });

    // 初始化应用
    async function initApp() {
        try {

            // 检查登录状态
            checkLoginStatus();

            // 加载技能列表
            await loadSkills();

            // 加载聊天会话
            await loadChatSessions();

            // 绑定事件
            bindEvents();

            console.log('应用初始化完成');
        } catch (error) {
            console.error('应用初始化失败:', error);
            alert('应用初始化失败，请刷新页面重试');
        }
    }

    // 检查登录状态
    function checkLoginStatus() {
        const savedUser = localStorage.getItem('currentUser');
        const token = localStorage.getItem('token');

        if (savedUser && token) {
            currentUser = JSON.parse(savedUser);
            isLoggedIn = true;
            updateUserInterface();
        }
    }

    // 更新用户界面状态
    function updateUserInterface() {
        const userNameElement = document.getElementById('userName');
        const userStatusElement = document.getElementById('userStatus');
        const messageInput = document.getElementById('messageInput');

        if (isLoggedIn && currentUser) {
            userNameElement.textContent = currentUser.username;
            userStatusElement.textContent = 'VIP会员';
            messageInput.placeholder = '请先选择一个技能，然后输入内容';
        } else {
            userNameElement.textContent = '未登录';
            userStatusElement.textContent = '点击登录';
            messageInput.placeholder = '请先登录并选择技能';
        }
    }

    // 显示登录模态框
    function showLoginModal() {
        document.getElementById('loginModal').classList.add('active');
    }

    // 隐藏登录模态框
    function hideLoginModal() {
        document.getElementById('loginModal').classList.remove('active');
    }

    // 处理登录
    async function handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();

        if (!username || !password) {
            alert('请输入用户名和密码');
            return;
        }

        try {
            const response = await apiRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });
            if (response.success) {

                isLoggedIn = true;
                currentUser = response.user;
                // 保存token和用户信息到本地存储
                localStorage.setItem('token', response.token);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // 更新界面
                updateUserInterface();
                hideLoginModal();

                // alert('登录成功！');
            } else {
                alert(response.message || '登录失败');
            }
        } catch (error) {
            console.error('登录失败:', error);
            alert('登录失败，请检查网络连接或稍后重试');
        }
    }

    // 处理注册
    async function handleRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();

        if (!username || !email || !password || !confirmPassword) {
            alert('请填写所有字段');
            return;
        }

        if (password !== confirmPassword) {
            alert('两次输入的密码不一致');
            return;
        }

        if (password.length < 6) {
            alert('密码长度至少6位');
            return;
        }

        try {
            const response = await apiRequest('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ username, email, password,confirmPassword})
            });

            if (response.success) {
                alert('注册成功！请登录');
                // 切换到登录标签
                document.querySelector('.login-tab[data-tab="login"]').click();
                // 清空注册表单
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                alert(response.message || '注册失败');
            }
        } catch (error) {
            console.error('注册失败:', error);
            alert('注册失败，请检查网络连接或稍后重试');
        }
    }

    // 处理QQ登录
    function handleQQLogin() {
        alert('QQ登录功能需要后端支持，当前为演示模式');
        // 在实际应用中，这里应该重定向到QQ OAuth授权页面
    }

    // 处理微信登录
    function handleWechatLogin() {
        alert('微信登录功能需要后端支持，当前为演示模式');
        // 在实际应用中，这里应该显示微信二维码
    }

    // 检查登录状态
    function checkAuth() {
        if (!isLoggedIn) {
            showLoginModal();
            return false;
        }
        return true;
    }

    // 加载技能列表
    async function loadSkills() {
        try {
            const response = await apiRequest('/skills');

            if (response.success) {
                allSkills = response.data;
                renderSkills();
                console.log('技能列表加载成功');
            } else {
                throw new Error(response.message || '加载技能列表失败');
            }
        } catch (error) {
            console.error('加载技能列表失败:', error);
            // 使用默认技能作为后备
            allSkills = getDefaultSkills();
            renderSkills();
        }
    }

    // 获取默认技能（后备方案）
    function getDefaultSkills() {
        return [
            { id: 'skill_1', name: '文本摘要', command: '/summarize', category: 'TEXT' },
            { id: 'skill_2', name: '英文翻译', command: '/translate_en', category: 'TEXT' },
            { id: 'skill_3', name: '中文翻译', command: '/translate_zh', category: 'TEXT' },
            { id: 'skill_4', name: '语法检查', command: '/grammar_check', category: 'TEXT' },
            { id: 'skill_5', name: '情感分析', command: '/sentiment_analysis', category: 'TEXT' },
            { id: 'skill_6', name: '关键词提取', command: '/extract_keywords', category: 'TEXT' },
            { id: 'skill_7', name: '文本分类', command: '/text_classification', category: 'TEXT' },
            { id: 'skill_8', name: '命名实体识别', command: '/ner', category: 'TEXT' },
            { id: 'skill_9', name: '文本纠错', command: '/text_correction', category: 'TEXT' },
            { id: 'skill_10', name: '文本生成', command: '/text_generation', category: 'TEXT' },
            { id: 'skill_11', name: '代码解释', command: '/explain_code', category: 'CODE' },
            { id: 'skill_12', name: '代码生成', command: '/generate_code', category: 'CODE' },
            { id: 'skill_13', name: '代码优化', command: '/optimize_code', category: 'CODE' },
            { id: 'skill_14', name: '代码调试', command: '/debug_code', category: 'CODE' },
            { id: 'skill_15', name: '问答系统', command: '/qa', category: 'ADVANCED' },
            { id: 'skill_16', name: '文本相似度', command: '/text_similarity', category: 'ADVANCED' },
            { id: 'skill_17', name: '文本聚类', command: '/text_clustering', category: 'ADVANCED' },
            { id: 'skill_18', name: '文本去重', command: '/deduplicate', category: 'ADVANCED' },
            { id: 'skill_19', name: '文本格式化', command: '/format_text', category: 'ADVANCED' },
            { id: 'skill_20', name: '文本加密', command: '/encrypt_text', category: 'ADVANCED' }
        ];
    }

    // 渲染技能列表
    function renderSkills() {
        const textSkillsContainer = document.getElementById('textSkills');
        const codeSkillsContainer = document.getElementById('codeSkills');
        const advancedSkillsContainer = document.getElementById('advancedSkills');

        // 清空容器
        textSkillsContainer.innerHTML = '';
        codeSkillsContainer.innerHTML = '';
        advancedSkillsContainer.innerHTML = '';

        // 按类别分组
        allSkills.forEach(skill => {
            const skillItem = createSkillItem(skill);

            switch(skill.category) {
                case 'TEXT':
                    textSkillsContainer.appendChild(skillItem);
                    break;
                case 'CODE':
                    codeSkillsContainer.appendChild(skillItem);
                    break;
                case 'ADVANCED':
                    advancedSkillsContainer.appendChild(skillItem);
                    break;
                default:
                    textSkillsContainer.appendChild(skillItem);
            }
        });
    }

    // 创建技能项
    function createSkillItem(skill) {
        const skillItem = document.createElement('div');
        skillItem.className = 'skill-item';
        skillItem.textContent = skill.name;
        skillItem.dataset.skillId = skill.id;
        skillItem.dataset.command = skill.command;

        skillItem.addEventListener('click', () => {
            if (!checkAuth()) return;
            selectSkill(skill);
        });

        return skillItem;
    }

    // 选择技能
    function selectSkill(skill) {
        // 移除之前选中的技能
        if (currentSkill) {
            const previousSkillItem = document.querySelector(`.skill-item[data-skill-id="${currentSkill.id}"]`);
            if (previousSkillItem) {
                previousSkillItem.classList.remove('active');
            }
        }

        // 设置当前技能
        currentSkill = skill;

        // 更新技能选择器按钮状态
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const currentSkillIndicator = document.getElementById('currentSkillIndicator');

        skillSelectorBtn.classList.add('active');
        if (currentSkillIndicator) {
            currentSkillIndicator.innerHTML = `当前技能: <span>${skill.name}</span>`;
        }

        // 更新技能项状态
        const skillItem = document.querySelector(`.skill-item[data-skill-id="${skill.id}"]`);
        if (skillItem) {
            skillItem.classList.add('active');
        }

        // 更新输入框提示
        const messageInput = document.getElementById('messageInput');
        messageInput.placeholder = `使用 ${skill.name} 技能，请输入内容...`;

        // 关闭技能选择菜单
        document.getElementById('skillSelectorMenu').classList.remove('show');

        console.log('已选择技能:', skill.name);
    }



    // 创建新聊天
    async function createNewChat() {
        if (!checkAuth()) return null;

        try {
            const response = await apiRequest('/chat/sessions', {
                method: 'POST',
                body: JSON.stringify({ title: '新对话' })
            });

            if (response.success) {
                const newSession = response.session;
                chatSessions[newSession.id] = newSession;
                currentChatId = newSession.id;

                updateChatHistoryList();
                showEmptyState();

                return newSession.id;
            } else {
                throw new Error(response.message || '创建新聊天失败');
            }
        } catch (error) {
            const status = parseInt(error.message.match(/status:\s*(\d+)/)?.[1] || 0);
            // console.error('创建新聊天失败:', error);
            // alert('创建新聊天失败: ' + error.message);
            if (status === 400 || status === 401) {
                loginout()
                checkAuth()
            }else {
                alert('创建新聊天失败: ' + error.message);
            }


            return null;
        }
    }

    // 显示空状态
    function showEmptyState() {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = `
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <p>开始与豆包对话吧！</p>
                <div class="hint">选择一个技能，然后输入您的内容</div>
            </div>
        `;
    }

    // 更新聊天历史列表
    function updateChatHistoryList() {
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML = '';

        // 按更新时间倒序排序
        const sortedChats = Object.values(chatSessions).sort((a, b) => {
            return new Date(b.updatedAt) - new Date(a.updatedAt);
        });

        sortedChats.forEach(chat => {
            const historyItem = document.createElement('div');
            historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
            historyItem.dataset.chatId = chat.id;

            // 获取最后一条消息作为预览
            const lastMessage = chat.messages && chat.messages.length > 0 ?
                chat.messages[chat.messages.length - 1] : null;
            const previewText = lastMessage ?
                (lastMessage.content && lastMessage.content.length > 20 ?
                    lastMessage.content.substring(0, 20) + '...' : lastMessage.content) :
                '新对话';

            historyItem.innerHTML = `
                <div class="history-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="history-info">
                    <div class="history-title">${chat.title}</div>
                    <div class="history-preview">${previewText}</div>
                </div>
                <button class="delete-chat-btn" title="删除聊天">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // 点击聊天项切换聊天
            historyItem.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-chat-btn')) {
                    switchToChat(chat.id);
                }
            });

            // 删除聊天按钮
            const deleteBtn = historyItem.querySelector('.delete-chat-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            });

            chatHistory.appendChild(historyItem);
        });
    }

    // 切换到指定聊天
    async function switchToChat(chatId) {
        if (!chatSessions[chatId]) {
            console.error('聊天会话不存在:', chatId);
            return;
        }

        currentChatId = chatId;
        const chat = chatSessions[chatId];

        // 先使用本地缓存的消息
        document.querySelector('.chat-name').textContent = chat.title;
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';

        // 显示本地缓存的消息
        chat.messages.forEach(message => {
            addMessageToUI(message);
        });

        // 可选：后台同步最新消息，但不覆盖本地数据
        try {
            const response = await apiRequest(`/chat/sessions/${chatId}/messages`);
            if (response.success && response.session && response.session.messages) {
                // 只添加本地没有的新消息
                response.session.messages.forEach(newMsg => {
                    if (!chat.messages.some(m => m.id === newMsg.id)) {
                        chat.messages.push(newMsg);
                    }
                });
                chat.updatedAt = new Date().toISOString();
                saveChatSessions();
                updateChatHistoryList();
            }
        } catch (error) {
            console.log('同步消息失败，使用本地缓存:', error);
        }

        resetCurrentSkill();
    }

    // 删除聊天
    async function deleteChat(chatId) {
        if (Object.keys(chatSessions).length <= 1) {
            alert('至少需要保留一个聊天会话');
            return;
        }

        try {
            const response = await apiRequest(`/chat/sessions/${chatId}`, {
                method: 'DELETE'
            });
            if (response.success) {
                delete chatSessions[chatId];

                // 如果删除的是当前聊天，切换到另一个聊天
                if (chatId === currentChatId) {
                    const remainingChatIds = Object.keys(chatSessions);
                    if (remainingChatIds.length > 0) {
                        await switchToChat(remainingChatIds[0]);
                    } else {
                        await createNewChat();
                    }
                }

                updateChatHistoryList();
                console.log('删除聊天成功:', chatId);
            } else {
                throw new Error(response.message || '删除聊天失败');
            }
        } catch (error) {
            console.error('删除聊天失败:', error);
            alert('删除聊天失败: ' + error.message);
        }
    }

    // 发送消息
    // 发送消息
    async function sendMessage() {
        if (!checkAuth()) return;

        if (isProcessing) {
            return; // 防止重复发送
        }

        const messageInput = document.getElementById('messageInput');
        const text = messageInput.value.trim();
        const sendButton = document.getElementById('sendButton');

        // 检查是否已选择技能
        if (!currentSkill) {
            alert('请先选择一个技能！');
            return;
        }

        if (text === '' && pendingImages.length === 0) {
            return;
        }

        isProcessing = true;
        sendButton.disabled = true;

        try {
            // 显示处理中指示器
            showProcessingIndicator();

            // 准备请求数据
            const requestData = {
                sessionId: currentChatId,
                content: text,
                skillId: currentSkill.id,
                imageUrls: pendingImages.map(img => img.data)
            };

            // 发送消息到后端
            const response = await apiRequest('/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            // 修复：这里应该是 response.success 而不是 response.imageData
            if (response.success) {
                // 添加消息到会话并保存
                const chat = chatSessions[currentChatId];
                chat.messages.push(userMessage);
                chat.messages.push(botMessage);
                chat.updatedAt = new Date().toISOString();

                // 更新会话标题（如果是第一条消息）
                if (chat.messages.filter(m => m.type === 'sent').length === 1) {
                    chat.title = userMessage.content.substring(0, 20) + (userMessage.content.length > 20 ? '...' : '');
                }

                saveChatSessions(); // 关键：保存变更
                updateChatHistoryList();
            }
        } catch (error) {
            console.error('发送消息失败:', error);
            hideProcessingIndicator();
            alert('发送消息失败: ' + error.message);
            isProcessing = false;
            sendButton.disabled = false;
        }
    }

    // 显示处理中指示器
    function showProcessingIndicator() {
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');

        if (emptyState) {
            emptyState.remove();
        }

        const processingDiv = document.createElement('div');
        processingDiv.className = 'message received';
        processingDiv.id = 'processingIndicator';

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';

        const content = document.createElement('div');
        content.className = 'message-content';

        const processingText = document.createElement('div');
        processingText.className = 'message-text';
        processingText.innerHTML = `
            <div>正在使用 ${currentSkill.name} 技能处理您的请求...</div>
            <div class="processing-indicator">
                <div class="processing-dots">
                    <div class="processing-dot"></div>
                    <div class="processing-dot"></div>
                    <div class="processing-dot"></div>
                </div>
            </div>
        `;

        content.appendChild(processingText);
        processingDiv.appendChild(avatar);
        processingDiv.appendChild(content);
        messagesContainer.appendChild(processingDiv);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 隐藏处理中指示器
    function hideProcessingIndicator() {
        const processingIndicator = document.getElementById('processingIndicator');
        if (processingIndicator) {
            processingIndicator.remove();
        }
    }

    // 添加消息到UI
    // 添加消息到UI
    function addMessageToUI(message) {
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');

        if (emptyState) {
            emptyState.remove();
        }
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.type === 'USER' ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = message.id;

        // 消息头像
        const messageAvatar = document.createElement('div');
        messageAvatar.className = 'message-avatar';
        messageAvatar.innerHTML = message.type === 'USER' ?
            '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

        // 消息内容
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        // 文本内容
        if (message.content) {
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = message.content;
            messageContent.appendChild(messageText);
        }

        // 图片内容 - 修复：处理base64图片数据
        let imagesToShow = [];

        // 处理 imageUrls 数组
        if (message.imageUrls && message.imageUrls.length > 0) {
            imagesToShow = imagesToShow.concat(message.imageUrls);
        }

        // 处理单个 imageData（base64格式）
        if (message.imageData) {
            imagesToShow.push(message.imageData);
        }

        // 处理后端返回的图片数据（可能在不同的字段中）
        if (message.data && typeof message.data === 'string' && message.data.startsWith('data:image/')) {
            imagesToShow.push(message.data);
        }

        if (imagesToShow.length > 0) {
            const messageImages = document.createElement('div');
            messageImages.className = 'message-images';

            imagesToShow.forEach(imageData => {
                const img = document.createElement('img');
                img.src = imageData;
                img.alt = '消息图片';
                img.className = 'message-image';
                img.onclick = () => previewImage(imageData);
                messageImages.appendChild(img);
            });

            messageContent.appendChild(messageImages);
        }

        // 消息时间
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        const timestamp = new Date(message.timestamp);
        messageTime.textContent = timestamp.toLocaleTimeString('zh-CN', {
            hour: '2-digit', minute: '2-digit'
        });
        messageContent.appendChild(messageTime);

        if (message.type === 'USER') {
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageAvatar);
        } else {
            messageDiv.appendChild(messageAvatar);
            messageDiv.appendChild(messageContent);
        }

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 重置当前技能
    function resetCurrentSkill() {
        currentSkill = null;

        // 更新技能选择器按钮状态
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const currentSkillIndicator = document.getElementById('currentSkillIndicator');

        skillSelectorBtn.classList.remove('active');
        if (currentSkillIndicator) {
            currentSkillIndicator.innerHTML = '';
        }

        // 移除所有技能项的激活状态
        document.querySelectorAll('.skill-item').forEach(item => {
            item.classList.remove('active');
        });

        // 更新输入框提示
        const messageInput = document.getElementById('messageInput');
        messageInput.placeholder = '请先选择一个技能，然后输入内容';
    }

    // 显示VIP积分模态框
    async function showVipModal() {
        try {
            const response = await apiRequest('/vip/info');

            if (response.success) {
                vipPoints = response.session.points;
                document.getElementById('vipPoints').textContent = vipPoints.toLocaleString();
                document.getElementById('vipLevelName').textContent = response.session.levelName;
            }
        } catch (error) {
            console.error('获取VIP信息失败:', error);
        }

        document.getElementById('vipModal').classList.add('active');
    }

    // 隐藏VIP积分模态框
    function hideVipModal() {
        document.getElementById('vipModal').classList.remove('active');
    }

    // 处理退出登录
    function handleLogout() {
        if (confirm('确定要退出登录吗？')) {
            // 清除登录状态
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('token');

            // 重置界面状态
            updateUserInterface();
            resetCurrentSkill();

            // 隐藏用户下拉菜单
            document.getElementById('userDropdown').classList.remove('active');

            // alert('已成功退出登录');
        }
    }


    // 直接退出登录
    function loginout() {
            // 清除登录状态
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('token');
            // 重置界面状态
            updateUserInterface();
            resetCurrentSkill();
            // 隐藏用户下拉菜单
            document.getElementById('userDropdown').classList.remove('active');
    }


    // 绑定事件
    function bindEvents() {
        // 关闭登录按钮
        document.getElementById('closeLoginBtn').addEventListener('click', hideLoginModal);

        // 用户头像点击事件
        document.getElementById('userProfile').addEventListener('click', (e) => {
            if (!isLoggedIn) {
                showLoginModal();
            } else {
                // 切换下拉菜单显示/隐藏
                const dropdown = document.getElementById('userDropdown');
                dropdown.classList.toggle('active');
            }
        });

        // 点击页面其他区域关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-profile')) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // VIP积分按钮点击事件
        document.getElementById('vipOption').addEventListener('click', () => {
            document.getElementById('userDropdown').classList.remove('active');
            showVipModal();
        });

        // 退出登录按钮点击事件
        document.getElementById('logoutOption').addEventListener('click', () => {
            document.getElementById('userDropdown').classList.remove('active');
            handleLogout();
        });

        // 关闭VIP模态框按钮
        document.getElementById('closeVipBtn').addEventListener('click', hideVipModal);

        // 登录相关事件
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        document.getElementById('qqLoginBtn').addEventListener('click', handleQQLogin);
        document.getElementById('wechatLoginBtn').addEventListener('click', handleWechatLogin);
        document.getElementById('goToRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.login-tab[data-tab="register"]').click();
        });
        document.getElementById('goToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.login-tab[data-tab="login"]').click();
        });

        // 登录标签切换
        document.querySelectorAll('.login-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');

                // 更新标签状态
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // 更新表单显示
                document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
                document.getElementById(`${tabName}Form`).classList.add('active');
            });
        });

        // 新建聊天按钮
        document.getElementById('newChatBtn').addEventListener('click', createNewChat);

        // 发送按钮
        document.getElementById('sendButton').addEventListener('click', sendMessage);

        // 上传图片按钮
        document.getElementById('uploadImageButton').addEventListener('click', () => {
            if (!checkAuth()) return;
            document.getElementById('imageInput').click();
        });

        // 消息输入框回车发送
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 图片选择
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);

        // 技能选择器
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const skillSelectorMenu = document.getElementById('skillSelectorMenu');

        skillSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!checkAuth()) return;
            skillSelectorMenu.classList.toggle('show');
        });

        // 点击页面其他区域关闭菜单
        document.addEventListener('click', () => {
            skillSelectorMenu.classList.remove('show');
        });

        // 阻止菜单内部点击事件冒泡
        skillSelectorMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 图片预览模态框点击关闭
        const imagePreviewModal = document.getElementById('imagePreviewModal');
        if (imagePreviewModal) {
            imagePreviewModal.addEventListener('click', function() {
                this.classList.remove('active');
            });
        }

        // VIP模态框点击关闭
        const vipModal = document.getElementById('vipModal');
        if (vipModal) {
            vipModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        }

        // VIP功能按钮
        document.getElementById('rechargeBtn').addEventListener('click', function() {
            alert('充值功能需要后端支持，当前为演示模式');
        });

        document.getElementById('vipHistoryBtn').addEventListener('click', function() {
            alert('积分记录功能需要后端支持，当前为演示模式');
        });

        // 初始化拖拽功能
        initDragAndDrop();
    }

    // 初始化拖拽功能
    function initDragAndDrop() {
        const chatApp = document.querySelector('.chat-app');
        const messagesContainer = document.getElementById('messagesContainer');

        // 阻止默认拖拽行为
        const preventDefault = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        // 拖拽进入
        const handleDragEnter = (e) => {
            preventDefault(e);
        };

        // 拖拽离开
        const handleDragLeave = (e) => {
            preventDefault(e);
        };

        // 放置文件
        const handleDrop = (e) => {
            preventDefault(e);

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files);
            }
        };

        // 为整个聊天应用添加拖拽事件
        chatApp.addEventListener('dragenter', handleDragEnter);
        chatApp.addEventListener('dragover', preventDefault);
        chatApp.addEventListener('dragleave', handleDragLeave);
        chatApp.addEventListener('drop', handleDrop);

        // 为消息容器单独添加拖拽事件
        messagesContainer.addEventListener('dragenter', handleDragEnter);
        messagesContainer.addEventListener('dragover', preventDefault);
        messagesContainer.addEventListener('dragleave', handleDragLeave);
        messagesContainer.addEventListener('drop', handleDrop);
    }

    // 处理图片选择
    function handleImageSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFileSelect(files);
        }
    }

    // 处理文件选择
    function handleFileSelect(files) {
        for (let file of files) {
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                continue;
            }

            // 检查文件大小（限制为2MB）
            if (file.size > 2 * 1024 * 1024) {
                alert(`图片 ${file.name} 太大，请选择小于2MB的图片`);
                continue;
            }

            // 检查总图片数量限制
            if (pendingImages.length >= 5) {
                alert('最多只能上传5张图片');
                break;
            }

            addPendingImage(file);
        }
    }

    // 补全 bindEvents 函数
    function bindEvents() {
        // 关闭登录按钮
        document.getElementById('closeLoginBtn').addEventListener('click', hideLoginModal);

        // 用户头像点击事件
        document.getElementById('userProfile').addEventListener('click', (e) => {
            if (!isLoggedIn) {
                showLoginModal();
            } else {
                // 切换下拉菜单显示/隐藏
                const dropdown = document.getElementById('userDropdown');
                dropdown.classList.toggle('active');
            }
        });

        // 点击页面其他区域关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-profile')) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // VIP积分按钮点击事件
        document.getElementById('vipOption').addEventListener('click', () => {
            document.getElementById('userDropdown').classList.remove('active');
            showVipModal();
        });

        // 退出登录按钮点击事件
        document.getElementById('logoutOption').addEventListener('click', () => {
            document.getElementById('userDropdown').classList.remove('active');
            handleLogout();
        });

        // 关闭VIP模态框按钮
        document.getElementById('closeVipBtn').addEventListener('click', hideVipModal);

        // 登录相关事件
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        document.getElementById('qqLoginBtn').addEventListener('click', handleQQLogin);
        document.getElementById('wechatLoginBtn').addEventListener('click', handleWechatLogin);

        // 登录/注册切换
        document.getElementById('goToRegister').addEventListener('click', (e) => {
            e.preventDefault();
            // 切换到注册标签
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === 'register') {
                    tab.classList.add('active');
                }
            });
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
                if (form.id === 'registerForm') {
                    form.classList.add('active');
                }
            });
        });

        document.getElementById('goToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            // 切换到登录标签
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === 'login') {
                    tab.classList.add('active');
                }
            });
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
                if (form.id === 'loginForm') {
                    form.classList.add('active');
                }
            });
        });

        // 登录标签切换
        document.querySelectorAll('.login-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');

                // 更新标签状态
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // 更新表单显示
                document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
                document.getElementById(`${tabName}Form`).classList.add('active');
            });
        });

        // 新建聊天按钮
        document.getElementById('newChatBtn').addEventListener('click', createNewChat);

        // 发送按钮
        document.getElementById('sendButton').addEventListener('click', sendMessage);

        // 上传图片按钮
        document.getElementById('uploadImageButton').addEventListener('click', () => {
            if (!checkAuth()) return;
            document.getElementById('imageInput').click();
        });

        // 消息输入框回车发送
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 图片选择
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);

        // 技能选择器
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const skillSelectorMenu = document.getElementById('skillSelectorMenu');

        skillSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!checkAuth()) return;
            skillSelectorMenu.classList.toggle('show');
        });

        // 点击页面其他区域关闭菜单
        document.addEventListener('click', () => {
            skillSelectorMenu.classList.remove('show');
        });

        // 阻止菜单内部点击事件冒泡
        skillSelectorMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 图片预览模态框点击关闭
        const imagePreviewModal = document.getElementById('imagePreviewModal');
        if (imagePreviewModal) {
            imagePreviewModal.addEventListener('click', function() {
                this.classList.remove('active');
            });
        }

        // VIP模态框点击关闭
        const vipModal = document.getElementById('vipModal');
        if (vipModal) {
            vipModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        }

        // VIP功能按钮
        document.getElementById('rechargeBtn').addEventListener('click', function() {
            alert('充值功能需要后端支持，当前为演示模式');
        });

        document.getElementById('vipHistoryBtn').addEventListener('click', function() {
            alert('积分记录功能需要后端支持，当前为演示模式');
        });

        // 初始化拖拽功能
        initDragAndDrop();
    }

    // 初始化拖拽功能
    function initDragAndDrop() {
        const chatApp = document.querySelector('.chat-app');
        const messagesContainer = document.getElementById('messagesContainer');

        // 阻止默认拖拽行为
        const preventDefault = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        // 拖拽进入
        const handleDragEnter = (e) => {
            preventDefault(e);
        };

        // 拖拽离开
        const handleDragLeave = (e) => {
            preventDefault(e);
        };

        // 放置文件
        const handleDrop = (e) => {
            preventDefault(e);

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files);
            }
        };

        // 为整个聊天应用添加拖拽事件
        chatApp.addEventListener('dragenter', handleDragEnter);
        chatApp.addEventListener('dragover', preventDefault);
        chatApp.addEventListener('dragleave', handleDragLeave);
        chatApp.addEventListener('drop', handleDrop);

        // 为消息容器单独添加拖拽事件
        messagesContainer.addEventListener('dragenter', handleDragEnter);
        messagesContainer.addEventListener('dragover', preventDefault);
        messagesContainer.addEventListener('dragleave', handleDragLeave);
        messagesContainer.addEventListener('drop', handleDrop);
    }

    // 处理图片选择
    function handleImageSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFileSelect(files);
        }
    }

    // 处理文件选择
    function handleFileSelect(files) {
        for (let file of files) {
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                continue;
            }

            // 检查文件大小（限制为2MB）
            if (file.size > 2 * 1024 * 1024) {
                alert(`图片 ${file.name} 太大，请选择小于2MB的图片`);
                continue;
            }

            // 检查总图片数量限制
            if (pendingImages.length >= 5) {
                alert('最多只能上传5张图片');
                break;
            }

            addPendingImage(file);
        }
    }

    // 添加图片到待发送列表
    function addPendingImage(file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const imageData = {
                id: Date.now() + Math.random(),
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result
            };

            pendingImages.push(imageData);
            updateImageThumbnails();
        };

        reader.onerror = function(error) {
            console.error('读取图片文件失败:', error);
            alert('读取图片文件失败，请重试');
        };

        reader.readAsDataURL(file);
    }

    // 更新图片缩略图显示
    function updateImageThumbnails() {
        const inputActions = document.getElementById('inputActions');
        const uploadButton = document.getElementById('uploadImageButton');

        // 清空除上传按钮外的所有内容
        inputActions.innerHTML = '';
        if (uploadButton) {
            inputActions.appendChild(uploadButton);
        }

        // 为每张图片创建一个缩略图
        pendingImages.forEach((image, index) => {
            const thumbnail = createImageThumbnail(image, index);
            inputActions.appendChild(thumbnail);
        });
    }

    // 创建图片缩略图
    function createImageThumbnail(image, index) {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'image-thumbnail';
        thumbnail.title = image.name;
        thumbnail.dataset.imageId = image.id;

        const img = document.createElement('img');
        img.src = image.data;
        img.alt = image.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            removePendingImage(image.id);
        };

        thumbnail.appendChild(img);
        thumbnail.appendChild(deleteBtn);

        // 点击缩略图预览图片
        thumbnail.onclick = () => previewImage(image.data);

        return thumbnail;
    }

    // 预览图片
    function previewImage(imageSrc) {
        const modal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');

        if (modal && previewImage) {
            previewImage.src = imageSrc;
            modal.classList.add('active');

            // 点击模态框背景关闭预览
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            };
        }
    }


    // 移除待发送图片
    function removePendingImage(imageId) {
        pendingImages = pendingImages.filter(img => img.id !== imageId);
        updateImageThumbnails();
    }

    // 清空所有待发送图片
    function clearPendingImages() {
        pendingImages = [];
        updateImageThumbnails();
    }

    // 预览图片

    function updateChatHistoryList() {
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML = '';

        // 按更新时间倒序排序
        const sortedChats = Object.values(chatSessions).sort((a, b) => {
            return new Date(b.updatedAt) - new Date(a.updatedAt);
        });

        sortedChats.forEach(chat => {
            const historyItem = document.createElement('div');
            historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
            historyItem.dataset.chatId = chat.id;

            // 获取最后一条消息作为预览
            const lastMessage = chat.messages && chat.messages.length > 0 ?
                chat.messages[chat.messages.length - 1] : null;
            const previewText = lastMessage ?
                (lastMessage.content && lastMessage.content.length > 20 ?
                    lastMessage.content.substring(0, 20) + '...' : lastMessage.content) :
                '新对话';

            historyItem.innerHTML = `
                <div class="history-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="history-info">
                    <div class="history-title">${chat.title}</div>
                    <div class="history-preview">${previewText}</div>
                </div>
                <button class="delete-chat-btn" title="删除聊天">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // 点击聊天项切换聊天
            historyItem.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-chat-btn')) {
                    switchToChat(chat.id);
                }
            });

            // 删除聊天按钮
            const deleteBtn = historyItem.querySelector('.delete-chat-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            });

            chatHistory.appendChild(historyItem);
        });
    }

    // 补全其他缺失的函数
    function renderSkills() {
        const textSkillsContainer = document.getElementById('textSkills');
        const codeSkillsContainer = document.getElementById('codeSkills');
        const advancedSkillsContainer = document.getElementById('advancedSkills');

        // 清空容器
        textSkillsContainer.innerHTML = '';
        codeSkillsContainer.innerHTML = '';
        advancedSkillsContainer.innerHTML = '';

        // 按类别分组
        allSkills.forEach(skill => {
            const skillItem = createSkillItem(skill);

            switch(skill.category) {
                case 'TEXT':
                    textSkillsContainer.appendChild(skillItem);
                    break;
                case 'CODE':
                    codeSkillsContainer.appendChild(skillItem);
                    break;
                case 'ADVANCED':
                    advancedSkillsContainer.appendChild(skillItem);
                    break;
                default:
                    textSkillsContainer.appendChild(skillItem);
            }
        });
    }

    函数 创建技能项(技能) {
        常量 技能项 = 文档.创建元素('div');
        技能项.类名 = '技能项';
        技能项.文本内容 = 技能.名称;
        技能项.数据集.技能ID = 技能.ID;
        技能项.数据集.命令 = 技能.命令;

        技能项.添加事件监听器('点击', () => {
            如果 (!检查认证()) 返回;
            选择技能(技能);
        });

        返回 技能项;
    }

    // 修改保存聊天会话函数，确保每次数据变更都被保存
    函数 保存聊天会话() {
        尝试 {
            localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
            // 同时保存当前聊天ID，避免刷新后丢失当前会话
            localStorage.setItem('currentChatId', currentChatId);
        } 捕获 (e) {
            控制台.错误('保存聊天记录失败:', e);
        }
    }

    // 修改加载聊天会话函数
    函数 加载聊天会话() {
        尝试{
            常量 保存 = localStorage.getItem('chatSessions');
            常量 保存当前ID = 本地存储.获取项('当前聊天ID');

            如果 (保存) {
                chatSessions = JSON.parse(saved);
            }

            如果 (保存的当前ID && 聊天会话[保存的当前ID]) {
                当前聊天ID = 保存的当前ID;
            } 否则 如果 (对象.键(聊天会话).长度 > 0) {
                当前聊天ID = 对象.键(聊天会话)[0];
            } 否则{
                创建新聊天();
            }

            更新聊天历史记录列表();
        } 捕获 (e) {
            控制台.错误('加载聊天记录失败:', e);
            // 加载失败时初始化新会话
            聊天会话 = {};
            创建新聊天();
        }
    }

</脚本>
</身体>
</html>

