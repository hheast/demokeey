<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片智能助手 - 技能选择</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-app {
            width: 1200px;
            height: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* 登录模态框样式 */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-modal.active {
            display: flex;
        }

        .login-container {
            width: 400px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        .close-login-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            z-index: 10;
        }

        .close-login-btn:hover {
            background: #e9ecef;
            color: #495057;
            transform: rotate(90deg);
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .login-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .login-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-body {
            padding: 30px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .login-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .login-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: #667eea;
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .social-login {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }

        .social-login::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #eee;
            z-index: 1;
        }

        .social-login span {
            background: white;
            padding: 0 15px;
            color: #777;
            font-size: 14px;
            position: relative;
            z-index: 2;
        }

        .social-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .social-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .social-btn.qq {
            background: #12B7F5;
        }

        .social-btn.wechat {
            background: #09BB07;
        }

        .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .register-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        /* 侧边栏 */
        .sidebar {
            width: 280px;
            background: #2d3748;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .user-profile {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #4a5568;
            cursor: pointer;
            position: relative;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-status {
            font-size: 12px;
            color: #a0aec0;
        }

        /* 用户下拉菜单 */
        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: hidden;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 20px;
            color: #2d3748;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }

        .user-dropdown-item:hover {
            background-color: #f7fafc;
        }

        .user-dropdown-item i {
            width: 20px;
            text-align: center;
        }

        .user-dropdown-item.vip {
            color: #d4af37;
            font-weight: 600;
        }

        .user-dropdown-item.logout {
            color: #e53e3e;
        }

        .new-chat-btn {
            margin: 20px;
            padding: 15px;
            background: #4a5568;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            background: #5a6578;
        }

        .new-chat-btn i {
            margin-right: 10px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .history-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            border-left: 3px solid transparent;
            position: relative;
        }

        .history-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .history-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #4a5568;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .history-info {
            flex: 1;
            min-width: 0;
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-preview {
            font-size: 12px;
            color: #a0aec0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-chat-btn {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: rgba(245, 101, 101, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .delete-chat-btn:hover {
            background: #f56565;
            transform: translateY(-50%) scale(1.1);
            opacity: 1;
        }

        /* 主聊天区域 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f7fafc;
        }

        .chat-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .chat-status {
            font-size: 13px;
            color: #718096;
        }

        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f7fafc;
        }

        .message {
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 15px;
        }

        .received .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            order: 1; /* 服务器消息头像在左侧 */
            margin-right: 15px;
        }

        .sent .message-avatar {
            order: 2; /* 用户消息头像在右侧 */
            margin-left: 15px;
            background: #e2e8f0;
            color: #718096;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
        }

        .received .message-content {
            background: white;
            border-top-left-radius: 5px;
        }

        .sent .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-top-right-radius: 5px;
        }

        .message-text {
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            object-fit: cover;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        /* 输入区域 */
        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .upload-image-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #f7fafc;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .upload-image-btn:hover {
            background: #edf2f7;
            color: #4a5568;
        }

        .message-input-container {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 15px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            background: #f7fafc;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .image-input {
            display: none;
        }

        /* 图片缩略图样式 */
        .image-thumbnail {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .image-thumbnail:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-thumbnail .delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-thumbnail:hover .delete-btn {
            opacity: 1;
        }

        /* 底部操作区域 */
        .bottom-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 技能选择器 */
        .skill-selector {
            position: relative;
            display: inline-block;
        }

        .skill-selector-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .skill-selector-btn:hover {
            background: #e9ecef;
        }

        .skill-selector-btn.active {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        .skill-selector-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .skill-selector-menu.show {
            display: block;
        }

        .skill-category {
            padding: 10px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .skill-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            padding: 10px;
        }

        .skill-item {
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            text-align: center;
        }

        .skill-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .skill-item.active {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        .current-skill-indicator {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
            font-weight: normal;
        }

        .current-skill-indicator span {
            font-weight: 600;
            color: #1565c0;
        }

        .tool-actions {
            display: flex;
            gap: 5px;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            color: #a0aec0;
            margin-top: 50%;
            transform: translateY(-50%);
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-state .hint {
            font-size: 14px;
            opacity: 0.7;
        }

        /* 图片预览模态框 */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .image-preview-modal.active {
            display: flex;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            overflow: hidden;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        /* VIP积分模态框 */
        .vip-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .vip-modal.active {
            display: flex;
        }

        .vip-container {
            width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .vip-header {
            background: linear-gradient(135deg, #d4af37 0%, #f7ef8a 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }

        .close-vip-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }

        .close-vip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .vip-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .vip-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .vip-body {
            padding: 30px;
        }

        .vip-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .vip-level {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vip-badge {
            background: #d4af37;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .vip-points {
            font-size: 24px;
            font-weight: 700;
            color: #d4af37;
        }

        .vip-features {
            margin-bottom: 20px;
        }

        .vip-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 0;
        }

        .vip-feature i {
            color: #d4af37;
        }

        .vip-actions {
            display: flex;
            gap: 10px;
        }

        .vip-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .vip-action-btn.primary {
            background: #d4af37;
            color: white;
        }

        .vip-action-btn.secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .vip-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        /* 处理指示器 */
        .processing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .processing-dots {
            display: flex;
            gap: 4px;
        }

        .processing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #667eea;
            animation: processing 1.5s infinite;
        }

        .processing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .processing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes processing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
<!-- 登录模态框 -->
<div class="login-modal" id="loginModal">
    <div class="login-container">
        <!-- 关闭按钮 -->
        <button class="close-login-btn" id="closeLoginBtn">
            <i class="fas fa-times"></i>
        </button>

        <div class="login-header">
            <h2>欢迎使用图片智能助手</h2>
            <p>请登录您的账户以继续使用</p>
        </div>
        <div class="login-body">
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">登录</div>
                <div class="login-tab" data-tab="register">注册</div>
            </div>

            <!-- 登录表单 -->
            <div class="login-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">用户名</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="请输入密码">
                </div>
                <button class="login-btn" id="loginBtn">登录</button>

                <div class="social-login">
                    <span>或使用以下方式登录</span>
                    <div class="social-buttons">
                        <div class="social-btn qq" id="qqLoginBtn">
                            <i class="fab fa-qq"></i>
                        </div>
                        <div class="social-btn wechat" id="wechatLoginBtn">
                            <i class="fab fa-weixin"></i>
                        </div>
                    </div>
                </div>

                <div class="register-link">
                    还没有账户？<a href="#" id="goToRegister">立即注册</a>
                </div>
            </div>

            <!-- 注册表单 -->
            <div class="login-form" id="registerForm">
                <div class="form-group">
                    <label for="registerUsername">用户名</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="registerEmail">邮箱</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label for="registerPassword">密码</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="请输入密码">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">确认密码</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="请再次输入密码">
                </div>
                <button class="login-btn" id="registerBtn">注册</button>

                <div class="register-link">
                    已有账户？<a href="#" id="goToLogin">立即登录</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- VIP积分模态框 -->
<div class="vip-modal" id="vipModal">
    <div class="vip-container">
        <div class="vip-header">
            <button class="close-vip-btn" id="closeVipBtn">
                <i class="fas fa-times"></i>
            </button>
            <h2>VIP会员中心</h2>
            <p>享受更多专属特权</p>
        </div>
        <div class="vip-body">
            <div class="vip-info">
                <div class="vip-level">
                    <div class="vip-badge">VIP会员</div>
                    <div id="vipLevelName">黄金会员</div>
                </div>
                <div class="vip-points" id="vipPoints">1,250</div>
            </div>
            <div class="vip-features">
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>无限制使用所有AI技能</span>
                </div>
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>优先处理您的请求</span>
                </div>
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>支持高清图片处理</span>
                </div>
                <div class="vip-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>专属客服支持</span>
                </div>
            </div>
            <div class="vip-actions">
                <button class="vip-action-btn primary" id="rechargeBtn">
                    <i class="fas fa-coins"></i> 充值积分
                </button>
                <button class="vip-action-btn secondary" id="vipHistoryBtn">
                    <i class="fas fa-history"></i> 积分记录
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 图片预览模态框 -->
<div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-content">
        <img id="previewImage" src="" alt="预览图片">
    </div>
</div>

<div class="chat-app">
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="user-profile" id="userProfile">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-name" id="userName">未登录</div>
            <div class="user-status" id="userStatus">点击登录</div>

            <!-- 用户下拉菜单 -->
            <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-item vip" id="vipOption">
                    <i class="fas fa-crown"></i>
                    <span>VIP积分</span>
                </div>
                <div class="user-dropdown-item logout" id="logoutOption">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>退出登录</span>
                </div>
            </div>
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i>
            <span>新建对话</span>
        </button>

        <div class="chat-history" id="chatHistory">
            <!-- 聊天历史会动态加载 -->
        </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chat-info">
                <div class="chat-name">豆包智能助手</div>
                <div class="chat-status">在线 · 选择一个技能开始对话</div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <p>开始与豆包对话吧！</p>
                <div class="hint">选择一个技能，然后输入您的内容</div>
            </div>
        </div>

        <div class="input-area">
            <!-- 图片缩略图容器 -->
            <div class="input-container">
                <div class="input-actions" id="inputActions">
                    <!-- 上传图片按钮 -->
                    <button class="upload-image-btn" id="uploadImageButton" title="上传图片">
                        <i class="fas fa-image"></i>
                    </button>
                    <!-- 图片缩略图会动态添加到这里 -->
                </div>

                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="请先选择一个技能，然后输入内容"></textarea>
                </div>

                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>

                <input type="file" id="imageInput" class="image-input" accept="image/*" multiple>
            </div>

            <!-- 底部操作区域 -->
            <div class="bottom-actions">
                <div class="skill-selector" id="skillSelector">
                    <button class="skill-selector-btn" id="skillSelectorBtn">
                        <i class="fas fa-magic"></i>
                        <span>选择技能</span>
                        <div class="current-skill-indicator" id="currentSkillIndicator"></div>
                    </button>
                    <div class="skill-selector-menu" id="skillSelectorMenu">
                        <div class="skill-category">文本处理</div>
                        <div class="skill-items" id="textSkills">
                            <!-- 文本处理技能会动态添加 -->
                        </div>

                        <div class="skill-category">代码相关</div>
                        <div class="skill-items" id="codeSkills">
                            <!-- 代码相关技能会动态添加 -->
                        </div>

                        <div class="skill-category">高级功能</div>
                        <div class="skill-items" id="advancedSkills">
                            <!-- 高级功能技能会动态添加 -->
                        </div>
                    </div>
                </div>

                <div class="tool-actions">
                    <button class="tool-btn" title="剪刀">
                        <i class="fas fa-cut"></i>
                    </button>
                    <button class="tool-btn" title="麦克风">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="tool-btn" title="发送">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    // 配置后端API地址
    const API_BASE_URL = '/api'; // 请替换为实际的后端API地址

    // 本地存储键名定义
    const STORAGE_KEYS = {
        CHAT_SESSIONS: 'image_assistant_chat_sessions',
        CURRENT_CHAT_ID: 'image_assistant_current_chat_id'
    };
    // ================= 基础配置（根据页面实际结构修改）=================
    const CONFIG = {
        // DOM元素ID（必须与页面HTML中的ID完全一致）
        MESSAGE_INPUT: 'messageInput',
        SEND_BTN: 'sendBtn',
        MESSAGES_CONTAINER: 'messagesContainer',
        CHAT_HISTORY: 'chatHistory',
        NEW_CHAT_BTN: 'newChatBtn',
        IMAGE_UPLOAD: 'imageUpload',
        IMAGE_PREVIEW_CONTAINER: 'imagePreviewContainer',
        CHAT_NAME: 'chatName', // 聊天标题元素的ID（原代码用class，这里统一用ID更可靠）
        SKILL_ITEM_CLASS: 'skill-item', // 技能选择项的class
        // 本地存储键名
        STORAGE_KEYS: {
            CHAT_SESSIONS: 'image_assistant_chat_sessions',
            CURRENT_CHAT_ID: 'image_assistant_current_chat_id'
        },
        // 后端接口（根据实际接口地址修改）
        // API_URL: '/chat/process'
        API_URL: '/api'
    };

    // ================= 全局变量（初始化默认值）=================
    let chatSessions = {}; // 所有聊天会话
    let currentChatId = null; // 当前激活的聊天ID
    let pendingImages = []; // 待发送的图片
    let currentSkill = null; // 当前选择的技能
    let isProcessing = false; // 是否正在处理请求（防止重复发送）
    let allSkills = [];
    let isLoggedIn = false;
    let currentUser = null;
    let vipPoints = 1250; // 初始VIP积分

    // 登录态Token（根据项目实际登录逻辑修改，这里先留空，后续可扩展）
    let AUTH_TOKEN = localStorage.getItem('auth_token') || document.cookie.split('; ').find(row => row.startsWith('auth_token='))?.split('=')[1] || '';

    // API请求函数
    async function apiRequest(endpoint, options = {}) {
        try {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 检查响应内容类型
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            } else if (contentType && contentType.includes('image/')) {
                const blob = await response.blob();
                const imageId = 'ai_img_' + Date.now();
                // 保存到浏览器缓存
                await browserCache.saveImage(imageId, blob);
                // 生成临时URL用于显示
                const imageUrl = URL.createObjectURL(blob);
                return {
                    success: true,
                    data: {
                        id: imageId,
                        type: 'AI',
                        content: '',
                        imageId: imageId, // 存储imageId而非完整数据
                        timestamp: new Date().toISOString()
                    }
                };
            }
        } catch (error) {
            console.error('API请求失败:', error);
            throw error;
        }
    }
    // ================= 本地存储核心函数 =================
    /** 从本地存储加载聊天记录 */


    /**
     * 更新技能选择器的可用状态
     */
    function updateSkillSelectorState() {
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const skillItems = document.querySelectorAll('.skill-item');

        if (isLoggedIn) {
            // 已登录，启用技能选择
            if (skillSelectorBtn) {
                skillSelectorBtn.disabled = false;
                skillSelectorBtn.style.opacity = '1';
                skillSelectorBtn.style.cursor = 'pointer';
            }

            skillItems.forEach(item => {
                item.style.pointerEvents = 'auto';
                item.style.opacity = '1';
            });
        } else {
            // 未登录，禁用技能选择
            if (skillSelectorBtn) {
                skillSelectorBtn.disabled = true;
                skillSelectorBtn.style.opacity = '0.5';
                skillSelectorBtn.style.cursor = 'not-allowed';
            }

            skillItems.forEach(item => {
                item.style.pointerEvents = 'none';
                item.style.opacity = '0.5';
            });

            // 重置当前技能
            resetCurrentSkill();
        }
    }

    function saveLoginStateToStorage() {
        try {
            if (isLoggedIn && currentUser && AUTH_TOKEN) {
                localStorage.setItem(STORAGE_KEYS.AUTH_TOKEN, AUTH_TOKEN);
                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                console.log('登录状态已保存到本地存储');
            } else {
                // 如果未登录，清除存储的登录状态
                clearLoginStateFromStorage();
            }
        } catch (error) {
            console.error('保存登录状态到本地存储失败:', error);
        }
    }

    // ================= 用户界面更新函数 =================

    /**
     * 更新用户界面状态
     */
    function updateUserInterface() {
        const userNameElement = document.getElementById('userName');
        const userStatusElement = document.getElementById('userStatus');
        const messageInput = document.getElementById('messageInput');
        const loginModal = document.getElementById('loginModal');

        if (isLoggedIn && currentUser) {
            userNameElement.textContent = currentUser.username || '用户';
            userStatusElement.textContent = 'VIP会员';
            if (messageInput) {
                messageInput.placeholder = '请先选择一个技能，然后输入内容';
            }

            // 确保登录模态框隐藏
            if (loginModal) {
                loginModal.classList.remove('active');
            }
        } else {
            userNameElement.textContent = '未登录';
            userStatusElement.textContent = '点击登录';
            if (messageInput) {
                messageInput.placeholder = '请先登录并选择技能';
            }
        }

        // 更新技能选择器的可用状态
        updateSkillSelectorState();
    }
    /**
     * 处理登录
     */
    async function handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();

        if (!username || !password) {
            alert('请输入用户名和密码');
            return;
        }

        try {
            // 模拟登录API请求
            const response = await apiRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (response.success) {
                // 登录成功

                isLoggedIn = true;
                currentUser = response.user || { username: username };
                AUTH_TOKEN = response.token || `token_${Date.now()}`;

                // 保存登录状态到本地存储
                saveLoginStateToStorage();

                // 更新界面
                updateUserInterface();
                hideLoginModal();

                // 清空登录表单
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';

                console.log('登录成功');
            } else {
                alert(response.message || '登录失败');
            }
        } catch (error) {
            console.error('登录失败:', error);
            alert('登录失败，请检查网络连接或稍后重试');
        }
    }

    // 从浏览器缓存加载聊天记录（替换原loadFromLocalStorage）
    async function loadFromLocalStorage() {
        try {
            await browserCache.initDB(); // 确保数据库初始化完成
            const allSessions = await new Promise((resolve) => {
                const transaction = browserCache.db.transaction([browserCache.chatStoreName], 'readonly');
                const store = transaction.objectStore(browserCache.chatStoreName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
            });

            if (allSessions.length > 0) {
                chatSessions = allSessions.reduce((obj, session) => {
                    obj[session.chatId] = session;
                    return obj;
                }, {});
                currentChatId = allSessions[0].chatId;
            }
            console.log('从浏览器缓存加载成功');
        } catch (error) {
            console.error('加载浏览器缓存失败:', error);
            chatSessions = {};
            currentChatId = null;
        }
    }

    // 保存聊天记录到浏览器缓存（替换原saveToLocalStorage）
    async function saveToLocalStorage() {
        try {
            await browserCache.initDB();
            if (currentChatId && chatSessions[currentChatId]) {
                await browserCache.saveChatSession(currentChatId, chatSessions[currentChatId]);
            }
            console.log('保存到浏览器缓存成功');
        } catch (error) {
            console.error('保存浏览器缓存失败:', error);
        }
    }

    // 增强清理旧会话的函数，支持指定保留数量
    function clearOldChats(keepCount = 5) {
        if (Object.keys(chatSessions).length <= keepCount) return;

        // 按更新时间排序（旧的在前，新的在后）
        const sortedChats = Object.values(chatSessions).sort((a, b) => {
            return new Date(a.updatedAt) - new Date(b.updatedAt);
        });

        // 需要删除的旧会话
        const chatsToRemove = sortedChats.slice(0, sortedChats.length - keepCount);
        chatsToRemove.forEach(chat => {
            delete chatSessions[chat.id];
            console.log('清理旧会话：', chat.id);
        });

        // 如果当前会话被删除了，切换到最新的会话
        if (!chatSessions[currentChatId]) {
            currentChatId = sortedChats[sortedChats.length - 1].id;
        }
    }

    // 定期检查并清理（可选，比如每小时检查一次）
    setInterval(() => {
        // 当会话数量超过10个时，自动清理到保留5个
        if (Object.keys(chatSessions).length > 10) {
            clearOldChats(5);
            saveToLocalStorage();
        }
    }, 3600000); // 3600000毫秒 = 1小时

    // 添加清理旧聊天记录的函数
    function clearOldChats() {
        const sortedChats = Object.values(chatSessions).sort((a, b) => {
            return new Date(a.updatedAt) - new Date(b.updatedAt);
        });
        // 保留最近的5个会话
        if (sortedChats.length > 5) {
            const chatsToRemove = sortedChats.slice(0, sortedChats.length - 5);
            chatsToRemove.forEach(chat => {
                delete chatSessions[chat.id];
            });
            saveToLocalStorage();
        }
    }
    // 修改初始化函数，确保正确加载
    function initChatSessions() {
        try {
            // 从本地存储加载
            const savedSessions = localStorage.getItem(CONFIG.STORAGE_KEYS.CHAT_SESSIONS);
            const savedCurrentChatId = localStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_CHAT_ID);

            if (savedSessions) {
                chatSessions = JSON.parse(savedSessions);
                currentChatId = savedCurrentChatId || Object.keys(chatSessions)[0];
            }

            // 确保至少有一个会话
            if (Object.keys(chatSessions).length === 0) {
                console.log('无历史会话，创建新对话');
                createNewChat();
            } else {
                // 切换到当前聊天ID
                switchToChat(currentChatId || Object.keys(chatSessions)[0]);
            }
        } catch (error) {
            console.error('初始化聊天会话失败：', error);
            // 初始化失败时重置
            chatSessions = {};
            currentChatId = null;
            createNewChat();
        }
    }



    /** 创建新聊天会话 */
    function createNewChat() {
        try {
            const chatId = `chat_${Date.now()}`;
            const newChat = {
                id: chatId,
                title: '新对话',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                messages: [
                    {
                        id: Date.now(),
                        type: 'received', // received=助手消息，sent=用户消息
                        content: '您好！我是豆包智能助手，请选择一个技能开始使用～',
                        timestamp: new Date().toISOString(),
                        images: []
                    }
                ]
            };
            // 添加到会话列表
            chatSessions[chatId] = newChat;
            // 保存到本地存储
            saveToLocalStorage();
            // 切换到新会话
            switchToChat(chatId);
            // 更新聊天历史列表UI
            updateChatHistoryList();
            console.log('创建新对话成功：', chatId);
            return chatId;
        } catch (error) {
            const status = parseInt(error.message.match(/status:\s*(\d+)/)?.[1] || 0);
            // console.error('创建新聊天失败:', error);
            // alert('创建新聊天失败: ' + error.message);
            if (status === 400 || status === 401) {
                // loginout()
                checkAuth()
            }else {
                alert('创建新聊天失败: ' + error.message);
            }
            // console.error('创建新对话失败：', error);
            // alert('创建新对话失败，请刷新页面重试');
        }
    }

    /** 切换到指定聊天会话 */
    function switchToChat(chatId) {
        try {
            if (!chatSessions[chatId]) {
                console.error('切换聊天失败：会话不存在');
                return;
            }

            // 更新当前聊天ID
            currentChatId = chatId;
            const currentChat = chatSessions[chatId];

            // 更新聊天标题UI
            const chatNameEl = document.getElementById(CONFIG.CHAT_NAME);
            if (chatNameEl) chatNameEl.textContent = currentChat.title;

            // 清空消息容器并重新渲染所有消息
            const messagesContainer = document.getElementById(CONFIG.MESSAGES_CONTAINER);
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
                // 重新渲染所有消息，包括图片
                currentChat.messages.forEach(message => addMessageToUI(message));
            }

            // 保存当前聊天ID到本地存储
            saveToLocalStorage();

            // 更新聊天历史列表UI
            updateChatHistoryList();

            // 滚动到最新消息
            scrollToBottom();

            console.log('切换到聊天会话：', chatId);
        } catch (error) {
            console.error('切换聊天失败：', error);
        }
    }

    /** 删除指定聊天会话 */
    function deleteChat(chatId) {
        try {
            // 至少保留一个会话
            if (Object.keys(chatSessions).length <= 1) {
                alert('至少需要保留一个聊天会话～');
                return;
            }
            // 删除会话
            delete chatSessions[chatId];
            console.log('删除聊天会话：', chatId);
            // 如果删除的是当前会话，切换到第一个可用会话
            if (chatId === currentChatId) {
                const remainingChatIds = Object.keys(chatSessions);
                switchToChat(remainingChatIds[0]);
            }
            // 保存到本地存储
            saveToLocalStorage();
            // 更新聊天历史列表UI
            updateChatHistoryList();
        } catch (error) {
            console.error('删除聊天失败：', error);
            alert('删除聊天失败，请刷新页面重试');
        }
    }

    // 修改添加消息到UI的函数，确保正确显示图片
    function addMessageToUI(message) {
        const messagesContainer = document.getElementById(CONFIG.MESSAGES_CONTAINER);
        if (!messagesContainer) return;

        // 移除空状态提示
        const emptyState = document.getElementById('emptyState');
        if (emptyState) {
            emptyState.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.type}`;
        messageDiv.dataset.messageId = message.id;

        // 构建消息内容
        let messageContent = '';

        // 添加文本内容
        if (message.content && message.content.trim() !== '') {
            messageContent += `<div class="message-text">${escapeHtml(message.content)}</div>`;
        }

        // 添加图片
        if (message.images && message.images.length > 0) {
            message.images.forEach(imageData => {
                messageContent += `
                <div class="message-image">
                    <img src="${imageData}" alt="消息图片"
                         style="max-width: 300px; max-height: 300px; border-radius: 8px;">
                </div>
            `;
            });
        }

        // 设置消息HTML
        messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="${message.type === 'sent' ? 'fas fa-user' : 'fas fa-robot'}"></i>
        </div>
        <div class="message-content">
            ${messageContent}
            <div class="message-time">${formatTimestamp(message.timestamp)}</div>
        </div>
    `;

        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    // ================= 消息发送与接收核心函数 =================
    /** 发送消息（对接后端 + 本地存储） */
    async function sendMessage() {
        if (!checkAuth()) return;
        try {
            // 1. 防重复发送
            if (isProcessing) return;
            // 2. 获取DOM元素
            const messageInput = document.getElementById(CONFIG.MESSAGE_INPUT);
            if (!messageInput) {
                console.error('发送失败：未找到消息输入框');
                return;
            }
            // 3. 收集输入内容（文本 + 图片）
            const text = messageInput.value.trim();
            const sendImages = [...pendingImages.map(img => img.dataUrl)]; // 复制图片数据，避免清空影响
            // 4. 校验（必须选择技能 + 有内容/图片）
            if (!currentSkill) {
                alert('请先选择一个技能再发送消息～');
                return;
            }
            if (text === '' && sendImages.length === 0) {
                alert('请输入消息内容或上传图片～');
                return;
            }
            // 5. 标记为处理中，防止重复发送
            isProcessing = true;
            // 6. 创建用户消息并更新UI
            const userMessage = {
                id: Date.now(),
                type: 'sent',
                content: text,
                images:  pendingImages.map(img => img.data),
                timestamp: new Date().toISOString()
            };
            const currentChat = chatSessions[currentChatId];
            currentChat.messages.push(userMessage);
            currentChat.updatedAt = new Date().toISOString();
            saveToLocalStorage();

            // 7. 首次发送消息时更新聊天标题
            if (currentChat.messages.length === 2) {
                currentChat.title = text.length > 15 ? text.substring(0, 15) + '...' : text;
            }




            // 9. 对接后端获取助手回复（核心）
            isProcessing = true;
            showLoadingIndicator(); // 显示加载中
            // 10. 发送请求到后端
            const response = await fetch('/api/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AUTH_TOKEN}` // 登录态Token（根据后端要求修改）
                },
                body: JSON.stringify({
                    chatId: currentChatId,
                    message: text,
                    skill: currentSkill,
                    images:  pendingImages,
                }),
                credentials: 'include' // 跨域时携带Cookie（如果后端用Cookie认证）
            });
            const result = await response.json();

            // 添加用户消息到UI
            addMessageToUI(userMessage);

            // 处理AI回复，包括可能的图片
            let assistantMessage;
            if (result.imageData) {
                // 有图片的回复
                assistantMessage = {
                    id: Date.now() + 1,
                    type: 'received',
                    content: result.reply || '这是生成的图片：',
                    images: [result.imageData],  // 存储图片数据
                    timestamp: new Date().toISOString()
                };
            } else {
                // 纯文本回复
                assistantMessage = {
                    id: Date.now() + 1,
                    type: 'received',
                    content: result.reply || '暂无回复',
                    images: [],
                    timestamp: new Date().toISOString()
                };
            }

            // 添加AI回复到会话并保存
            currentChat.messages.push(assistantMessage);
            currentChat.updatedAt = new Date().toISOString();
            addMessageToUI(assistantMessage);


        } catch (error) {
            console.error('发送消息失败：', error);
            showErrorMessage('发送失败：' + error.message);
        } finally {
            // 13. 重置状态
            isProcessing = false;
            hideLoadingIndicator(); // 隐藏加载中
            scrollToBottom(); // 滚动到最新消息
        }
    }
    /**
     * 显示登录模态框
     */
    function showLoginModal() {
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            loginModal.classList.add('active');
        }
    }


    // 显示处理中指示器
    function showProcessingIndicator() {
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');

        if (emptyState) {
            emptyState.remove();
        }

        const processingDiv = document.createElement('div');
        processingDiv.className = 'message received';
        processingDiv.id = 'processingIndicator';

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';

        const content = document.createElement('div');
        content.className = 'message-content';

        const processingText = document.createElement('div');
        processingText.className = 'message-text';
        processingText.innerHTML = `
            <div>正在使用 ${currentSkill.name} 技能处理您的请求...</div>
            <div class="processing-indicator">
                <div class="processing-dots">
                    <div class="processing-dot"></div>
                    <div class="processing-dot"></div>
                    <div class="processing-dot"></div>
                </div>
            </div>
        `;

        content.appendChild(processingText);
        processingDiv.appendChild(avatar);
        processingDiv.appendChild(content);
        messagesContainer.appendChild(processingDiv);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 隐藏处理中指示器
    function hideProcessingIndicator() {
        const processingIndicator = document.getElementById('processingIndicator');
        if (processingIndicator) {
            processingIndicator.remove();
        }
    }
    // ================= 图片处理函数 =================
    /** 处理图片上传（暂存 + 预览） */


// 处理图片上传（修改原handleImageUpload）
    function handleImageUpload(files) {
        try {
            if (!files || files.length === 0) return;
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('请上传图片格式的文件～');
                    return;
                }
                // 直接读取为Blob（而非Base64）
                const reader = new FileReader();
                reader.onload = (e) => {
                    const blob = new Blob([e.target.result], { type: file.type });
                    const imageId = `img_${Date.now()}_${Math.random()}`;
                    // 保存图片到IndexedDB
                    browserCache.saveImage(imageId, blob).then(() => {
                        // 待发送列表只存imageId（不存完整数据）
                        pendingImages.push({ imageId, name: file.name, type: file.type });
                        showImagePreview(URL.createObjectURL(blob)); // 临时URL用于预览
                        console.log('图片已保存到浏览器缓存');
                    });
                };
                reader.readAsArrayBuffer(file); // 读取为ArrayBuffer，便于转Blob
            });
        } catch (error) {
            console.error('图片处理失败:', error);
        }
    }

    // 显示图片预览（修改原showImagePreview）
    function showImagePreview(blobUrl) {
        const previewContainer = document.getElementById(CONFIG.IMAGE_PREVIEW_CONTAINER);
        if (!previewContainer) return;
        const previewEl = document.createElement('div');
        previewEl.className = 'image-preview-item';
        previewEl.innerHTML = `
    <img src="${blobUrl}" alt="预览图片" style="max-width: 100px; max-height: 100px;">
    <button class="remove-preview-btn">×</button>
  `;
        previewEl.querySelector('.remove-preview-btn').addEventListener('click', () => {
            previewEl.remove();
            URL.revokeObjectURL(blobUrl); // 释放临时URL
        });
        previewContainer.appendChild(previewEl);
    }




    // ================= UI渲染辅助函数 =================
    function saveToLocalStorage() {
        try {
            // 确保chatSessions和currentChatId存在
            if (chatSessions && typeof chatSessions === 'object') {
                localStorage.setItem(
                    CONFIG.STORAGE_KEYS.CHAT_SESSIONS,
                    JSON.stringify(chatSessions)
                );
            }
            if (currentChatId) {
                localStorage.setItem(CONFIG.STORAGE_KEYS.CURRENT_CHAT_ID, currentChatId);
            }
            console.log('保存到本地存储成功');
        } catch (error) {
            console.error('保存本地存储失败：', error);
            // 处理存储容量超限的情况
            if (error.name === 'QuotaExceededError') {
                alert('本地存储空间不足，部分聊天记录可能无法保存');
                // 可选：清理旧数据
                clearOldChats();
            }
        }
    }
    // 重置当前技能
    function resetCurrentSkill() {
        currentSkill = null;

        // 更新技能选择器按钮状态
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const currentSkillIndicator = document.getElementById('currentSkillIndicator');

        skillSelectorBtn.classList.remove('active');
        if (currentSkillIndicator) {
            currentSkillIndicator.innerHTML = '';
        }

        // 移除所有技能项的激活状态
        document.querySelectorAll('.skill-item').forEach(item => {
            item.classList.remove('active');
        });

        // 更新输入框提示
        const messageInput = document.getElementById('messageInput');
        messageInput.placeholder = '请先选择一个技能，然后输入内容';
    }
    /** 显示加载中指示器 */
    function showLoadingIndicator() {
        const messagesContainer = document.getElementById(CONFIG.MESSAGES_CONTAINER);
        if (!messagesContainer) return;
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message message-received loading';
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.innerHTML = `
        <div class="message-content">
            <i class="fas fa-spinner fa-spin"></i> 助手正在思考中...
        </div>
    `;
        messagesContainer.appendChild(loadingDiv);
    }
    // 显示VIP积分模态框
    async function showVipModal() {
        try {
            const response = await apiRequest('/vip/info');

            if (response.success) {
                vipPoints = response.session.points;
                document.getElementById('vipPoints').textContent = vipPoints.toLocaleString();
                document.getElementById('vipLevelName').textContent = response.session.levelName;
            }
        } catch (error) {
            console.error('获取VIP信息失败:', error);
        }

        document.getElementById('vipModal').classList.add('active');
    }
    /** 隐藏加载中指示器 */
    function hideLoadingIndicator() {
        const loadingDiv = document.getElementById('loadingIndicator');
        if (loadingDiv) loadingDiv.remove();
    }

    // 隐藏VIP积分模态框
    function hideVipModal() {
        document.getElementById('vipModal').classList.remove('active');
    }
    /** 显示错误消息 */
    function showErrorMessage(text) {
        const messagesContainer = document.getElementById(CONFIG.MESSAGES_CONTAINER);
        if (!messagesContainer) return;
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message message-received error';
        errorDiv.innerHTML = `
        <div class="message-content">
            <i class="fas fa-exclamation-circle"></i> ${escapeHtml(text)}
        </div>
    `;
        messagesContainer.appendChild(errorDiv);
    }
    /**
     * 处理退出登录
     */
    function handleLogout() {
        if (confirm('确定要退出登录吗？')) {
            // 清除登录状态
            isLoggedIn = false;
            currentUser = null;
            AUTH_TOKEN = '';

            // 清除本地存储中的登录状态
            clearLoginStateFromStorage();

            // 重置界面状态
            updateUserInterface();
            resetCurrentSkill();

            // 隐藏用户下拉菜单
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown) {
                userDropdown.classList.remove('active');
            }

            console.log('已退出登录');
        }
    }
    /** 更新聊天历史列表UI */
    function updateChatHistoryList() {
        try {
            const chatHistoryEl = document.getElementById(CONFIG.CHAT_HISTORY);
            if (!chatHistoryEl) {
                console.error('更新聊天列表失败：未找到聊天历史容器');
                return;
            }
            // 清空列表
            chatHistoryEl.innerHTML = '';
            // 按更新时间倒序排序（最新的在前面）
            const sortedChats = Object.values(chatSessions).sort((a, b) => {
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });
            // 渲染每个聊天项
            sortedChats.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
                historyItem.dataset.chatId = chat.id;


                // 获取最后一条消息作为预览（补充图片判断）
                // 修改后：判断是否为图片消息
                const lastMessage = chat.messages[chat.messages.length - 1];
                let previewText;
                if (lastMessage.images && lastMessage.images.length > 0) {
                    previewText = '[图片]'; // 图片消息显示提示
                } else {
                    previewText = lastMessage.content.length > 20 ?
                        lastMessage.content.substring(0, 20) + '...' : lastMessage.content;
                }

                // 聊天项HTML
                historyItem.innerHTML = `
                <div class="history-icon" style="margin-right: 8px;">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="history-info" style="flex: 1;">
                    <div class="history-title" style="font-weight: 500; margin-bottom: 2px;">${chat.title}</div>
                    <div class="history-preview" style="font-size: 12px; color: #999;">${previewText}</div>
                </div>
                <button class="delete-chat-btn" title="删除聊天" style="background: transparent; border: none; color: #999; cursor: pointer; margin-left: 8px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
                // 绑定切换聊天事件
                historyItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat-btn')) {
                        switchToChat(chat.id);
                    }
                });
                // 绑定删除聊天事件
                const deleteBtn = historyItem.querySelector('.delete-chat-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('确定要删除这个聊天会话吗？')) {
                        deleteChat(chat.id);
                    }
                });
                // 添加到列表
                chatHistoryEl.appendChild(historyItem);
            });
        } catch (error) {
            console.error('更新聊天列表失败：', error);
        }
    }

    // IndexedDB 工具类：管理聊天记录和图片
    class BrowserCache {
        constructor() {
            this.dbName = 'ChatCacheDB';
            this.chatStoreName = 'chatSessions'; // 存储聊天会话
            this.imageStoreName = 'images'; // 存储图片Blob
            this.initDB();
        }

        // 初始化数据库
        initDB() {
            return new Promise((resolve, reject) => {
                const request = window.indexedDB.open(this.dbName, 1);

                // 数据库版本升级时创建存储对象
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    // 创建聊天会话存储（以chatId为键）
                    if (!db.objectStoreNames.contains(this.chatStoreName)) {
                        db.createObjectStore(this.chatStoreName, { keyPath: 'chatId' });
                    }
                    // 创建图片存储（以图片ID为键）
                    if (!db.objectStoreNames.contains(this.imageStoreName)) {
                        db.createObjectStore(this.imageStoreName, { keyPath: 'imageId' });
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('IndexedDB初始化失败:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 保存聊天会话
        saveChatSession(chatId, sessionData) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.chatStoreName], 'readwrite');
                const store = transaction.objectStore(this.chatStoreName);
                const request = store.put({ chatId, ...sessionData });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // 获取聊天会话
        getChatSession(chatId) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.chatStoreName], 'readonly');
                const store = transaction.objectStore(this.chatStoreName);
                const request = store.get(chatId);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // 保存图片（存储Blob而非Base64）
        saveImage(imageId, blob) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.imageStoreName], 'readwrite');
                const store = transaction.objectStore(this.imageStoreName);
                // 存储Blob和元数据
                const request = store.put({
                    imageId,
                    blob,
                    timestamp: new Date().toISOString()
                });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // 获取图片Blob
        getImage(imageId) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.imageStoreName], 'readonly');
                const store = transaction.objectStore(this.imageStoreName);
                const request = store.get(imageId);
                request.onsuccess = () => resolve(request.result?.blob);
                request.onerror = () => reject(request.error);
            });
        }
    }

    // 初始化缓存实例
    const browserCache = new BrowserCache();






    /** 滚动到最新消息 */
    function scrollToBottom() {
        const messagesContainer = document.getElementById(CONFIG.MESSAGES_CONTAINER);
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // ================= 工具函数 =================
    /** 格式化时间戳（例：2025-11-21 14:30:25） */
// 添加时间格式化函数
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // 添加HTML转义函数，防止XSS
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ================= 事件绑定（核心！确保所有交互生效）=================
    function bindAllEvents() {
        console.log('开始绑定交互事件...');
        // 1. 发送按钮点击事件
        const sendBtn = document.getElementById(CONFIG.SEND_BTN);
        if (sendBtn) {
            sendBtn.addEventListener('click', sendMessage);
            console.log('绑定发送按钮事件成功');
        } else {
            console.warn('未找到发送按钮，发送功能不可用（请检查ID：', CONFIG.SEND_BTN, '）');
        }

        // 2. 回车发送事件（不按shift时）
        const messageInput = document.getElementById(CONFIG.MESSAGE_INPUT);
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            console.log('绑定回车发送事件成功');
        } else {
            console.warn('未找到消息输入框，输入功能不可用（请检查ID：', CONFIG.MESSAGE_INPUT, '）');
        }

        // 3. 图片上传事件
        const imageUpload = document.getElementById(CONFIG.IMAGE_UPLOAD);
        if (imageUpload) {
            imageUpload.addEventListener('change', (e) => handleImageUpload(e.target.files));
            console.log('绑定图片上传事件成功');
        } else {
            console.warn('未找到图片上传框，图片上传功能不可用（请检查ID：', CONFIG.IMAGE_UPLOAD, '）');
        }

        // 4. 技能选择事件（根据class绑定）
        const skillItems = document.querySelectorAll(`.${CONFIG.SKILL_ITEM_CLASS}`);
        if (skillItems.length > 0) {
            skillItems.forEach(item => {
                item.addEventListener('click', () => {
                    // 移除其他技能的active类
                    skillItems.forEach(i => i.classList.remove('active'));
                    // 给当前选中的技能添加active类
                    item.classList.add('active');
                    // 获取技能值（从data-skill属性）
                    currentSkill = item.dataset.skill;
                    console.log('选中技能：', currentSkill);
                    alert(`已选择技能：${item.textContent.trim()}`);
                });
            });
            console.log('绑定技能选择事件成功（共', skillItems.length, '个技能）');
        } else {
            console.warn('未找到技能选择项，技能选择功能不可用（请检查class：', CONFIG.SKILL_ITEM_CLASS, '）');
        }

        // 5. 新建聊天按钮事件
        const newChatBtn = document.getElementById(CONFIG.NEW_CHAT_BTN);
        if (newChatBtn) {
            newChatBtn.addEventListener('click', createNewChat);
            console.log('绑定新建聊天按钮事件成功');
        } else {
            console.warn('未找到新建聊天按钮，新建功能不可用（请检查ID：', CONFIG.NEW_CHAT_BTN, '）');
        }

        console.log('事件绑定完成');
    }
    // 处理图片选择
    function handleImageSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFileSelect(files);
        }
    }
    /**
     * 隐藏登录模态框
     */
    function hideLoginModal() {
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            loginModal.classList.remove('active');
        }
    }

    // 绑定事件
    function bindEvents() {
        // 关闭登录按钮
        document.getElementById('closeLoginBtn').addEventListener('click', hideLoginModal);

        // 用户头像点击事件
        document.getElementById('userProfile').addEventListener('click', (e) => {
            if (!isLoggedIn) {
                showLoginModal();
            } else {
                // 切换下拉菜单显示/隐藏
                const dropdown = document.getElementById('userDropdown');
                dropdown.classList.toggle('active');
            }
        });

        // 点击页面其他区域关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-profile')) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // VIP积分按钮点击事件
        document.getElementById('vipOption').addEventListener('click', () => {
            document.getElementById('userDropdown').classList.remove('active');
            showVipModal();
        });

        // 退出登录按钮点击事件
        document.getElementById('logoutOption').addEventListener('click', () => {
            document.getElementById('userDropdown').classList.remove('active');
            handleLogout();
        });

        // 关闭VIP模态框按钮
        document.getElementById('closeVipBtn').addEventListener('click', hideVipModal);

        // 登录相关事件
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        document.getElementById('qqLoginBtn').addEventListener('click', handleQQLogin);
        document.getElementById('wechatLoginBtn').addEventListener('click', handleWechatLogin);
        document.getElementById('goToRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.login-tab[data-tab="register"]').click();
        });
        document.getElementById('goToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.login-tab[data-tab="login"]').click();
        });

        // 登录标签切换
        document.querySelectorAll('.login-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');

                // 更新标签状态
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // 更新表单显示
                document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
                document.getElementById(`${tabName}Form`).classList.add('active');
            });
        });

        // 新建聊天按钮
        document.getElementById('newChatBtn').addEventListener('click', createNewChat);

        // 发送按钮
        document.getElementById('sendButton').addEventListener('click', sendMessage);

        // 上传图片按钮
        document.getElementById('uploadImageButton').addEventListener('click', () => {
            // if (!checkAuth()) return;
            document.getElementById('imageInput').click();
        });

        // 消息输入框回车发送
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 图片选择
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);

        // 技能选择器
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const skillSelectorMenu = document.getElementById('skillSelectorMenu');

        skillSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // if (!checkAuth()) return;
            skillSelectorMenu.classList.toggle('show');
        });

        // 点击页面其他区域关闭菜单
        document.addEventListener('click', () => {
            skillSelectorMenu.classList.remove('show');
        });

        // 阻止菜单内部点击事件冒泡
        skillSelectorMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 图片预览模态框点击关闭
        const imagePreviewModal = document.getElementById('imagePreviewModal');
        if (imagePreviewModal) {
            imagePreviewModal.addEventListener('click', function() {
                this.classList.remove('active');
            });
        }

        // VIP模态框点击关闭
        const vipModal = document.getElementById('vipModal');
        if (vipModal) {
            vipModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        }

        // VIP功能按钮
        document.getElementById('rechargeBtn').addEventListener('click', function() {
            alert('充值功能需要后端支持，当前为演示模式');
        });

        document.getElementById('vipHistoryBtn').addEventListener('click', function() {
            alert('积分记录功能需要后端支持，当前为演示模式');
        });

        // 初始化拖拽功能
        initDragAndDrop();
    }
    // 检查登录状态
    function checkAuth() {
        if (!isLoggedIn) {
            showLoginModal();
            return false;
        }
        return true;
    }

    // 初始化拖拽功能
    function initDragAndDrop() {
        const chatApp = document.querySelector('.chat-app');
        const messagesContainer = document.getElementById('messagesContainer');

        // 阻止默认拖拽行为
        const preventDefault = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        // 拖拽进入
        const handleDragEnter = (e) => {
            preventDefault(e);
        };

        // 拖拽离开
        const handleDragLeave = (e) => {
            preventDefault(e);
        };

        // 放置文件
        const handleDrop = (e) => {
            preventDefault(e);

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files);
            }
        };

        // 为整个聊天应用添加拖拽事件
        chatApp.addEventListener('dragenter', handleDragEnter);
        chatApp.addEventListener('dragover', preventDefault);
        chatApp.addEventListener('dragleave', handleDragLeave);
        chatApp.addEventListener('drop', handleDrop);

        // 为消息容器单独添加拖拽事件
        messagesContainer.addEventListener('dragenter', handleDragEnter);
        messagesContainer.addEventListener('dragover', preventDefault);
        messagesContainer.addEventListener('dragleave', handleDragLeave);
        messagesContainer.addEventListener('drop', handleDrop);
    }
    // 处理注册
    async function handleRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();

        if (!username || !email || !password || !confirmPassword) {
            alert('请填写所有字段');
            return;
        }

        if (password !== confirmPassword) {
            alert('两次输入的密码不一致');
            return;
        }

        if (password.length < 6) {
            alert('密码长度至少6位');
            return;
        }

        try {
            const response = await apiRequest('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ username, email, password,confirmPassword})
            });

            if (response.success) {
                alert('注册成功！请登录');
                // 切换到登录标签
                document.querySelector('.login-tab[data-tab="login"]').click();
                // 清空注册表单
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                alert(response.message || '注册失败');
            }
        } catch (error) {
            console.error('注册失败:', error);
            alert('注册失败，请检查网络连接或稍后重试');
        }
    }
    // 处理文件选择
    function handleFileSelect(files) {
        for (let file of files) {
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                continue;
            }

            // 检查文件大小（限制为2MB）
            if (file.size > 2 * 1024 * 1024) {
                alert(`图片 ${file.name} 太大，请选择小于2MB的图片`);
                continue;
            }

            // 检查总图片数量限制
            if (pendingImages.length >= 5) {
                alert('最多只能上传5张图片');
                break;
            }

            addPendingImage(file);
        }
    }
    // 处理QQ登录
    function handleQQLogin() {
        alert('QQ登录功能需要后端支持，当前为演示模式');
        // 在实际应用中，这里应该重定向到QQ OAuth授权页面
    }
    // 添加图片到待发送列表
    function addPendingImage(file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const imageData = {
                id: Date.now() + Math.random(),
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result
            };

            pendingImages.push(imageData);
            updateImageThumbnails();
        };

        reader.onerror = function(error) {
            console.error('读取图片文件失败:', error);
            alert('读取图片文件失败，请重试');
        };

        reader.readAsDataURL(file);
    }
    // 处理微信登录
    function handleWechatLogin() {
        alert('微信登录功能需要后端支持，当前为演示模式');
        // 在实际应用中，这里应该显示微信二维码
    }
    // 更新图片缩略图显示
    function updateImageThumbnails() {
        const inputActions = document.getElementById('inputActions');
        const uploadButton = document.getElementById('uploadImageButton');

        // 清空除上传按钮外的所有内容
        inputActions.innerHTML = '';
        if (uploadButton) {
            inputActions.appendChild(uploadButton);
        }

        // 为每张图片创建一个缩略图
        pendingImages.forEach((image, index) => {
            const thumbnail = createImageThumbnail(image, index);
            inputActions.appendChild(thumbnail);
        });
    }
    // 创建图片缩略图
    function createImageThumbnail(image, index) {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'image-thumbnail';
        thumbnail.title = image.name;
        thumbnail.dataset.imageId = image.id;

        const img = document.createElement('img');
        img.src = image.data;
        img.alt = image.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            removePendingImage(image.id);
        };

        thumbnail.appendChild(img);
        thumbnail.appendChild(deleteBtn);

        // 点击缩略图预览图片
        thumbnail.onclick = () => previewImage(image.data);

        return thumbnail;
    }
    // 移除待发送图片
    function removePendingImage(imageId) {
        pendingImages = pendingImages.filter(img => img.id !== imageId);
        updateImageThumbnails();
    }
    // 预览图片
    function previewImage(imageSrc) {
        const modal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');

        if (modal && previewImage) {
            previewImage.src = imageSrc;
            modal.classList.add('active');

            // 点击模态框背景关闭预览
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            };
        }
    }
    // 加载技能列表
    async function loadSkills() {
        try {
            const response = await apiRequest('/skills');

            if (response.success) {
                allSkills = response.data;
                renderSkills();
                console.log('技能列表加载成功');
            } else {
                throw new Error(response.message || '加载技能列表失败');
            }
        } catch (error) {
            console.error('加载技能列表失败:', error);
            // 使用默认技能作为后备
            allSkills = getDefaultSkills();
            renderSkills();
        }
    }

    // 获取默认技能（后备方案）
    function getDefaultSkills() {
        return [
            { id: 'skill_1', name: '文本摘要', command: '/summarize', category: 'TEXT' },
            { id: 'skill_2', name: '英文翻译', command: '/translate_en', category: 'TEXT' },
            { id: 'skill_3', name: '中文翻译', command: '/translate_zh', category: 'TEXT' },
            { id: 'skill_4', name: '语法检查', command: '/grammar_check', category: 'TEXT' },
            { id: 'skill_5', name: '情感分析', command: '/sentiment_analysis', category: 'TEXT' },
            { id: 'skill_6', name: '关键词提取', command: '/extract_keywords', category: 'TEXT' },
            { id: 'skill_7', name: '文本分类', command: '/text_classification', category: 'TEXT' },
            { id: 'skill_8', name: '命名实体识别', command: '/ner', category: 'TEXT' },
            { id: 'skill_9', name: '文本纠错', command: '/text_correction', category: 'TEXT' },
            { id: 'skill_10', name: '文本生成', command: '/text_generation', category: 'TEXT' },
            { id: 'skill_11', name: '代码解释', command: '/explain_code', category: 'CODE' },
            { id: 'skill_12', name: '代码生成', command: '/generate_code', category: 'CODE' },
            { id: 'skill_13', name: '代码优化', command: '/optimize_code', category: 'CODE' },
            { id: 'skill_14', name: '代码调试', command: '/debug_code', category: 'CODE' },
            { id: 'skill_15', name: '问答系统', command: '/qa', category: 'ADVANCED' },
            { id: 'skill_16', name: '文本相似度', command: '/text_similarity', category: 'ADVANCED' },
            { id: 'skill_17', name: '文本聚类', command: '/text_clustering', category: 'ADVANCED' },
            { id: 'skill_18', name: '文本去重', command: '/deduplicate', category: 'ADVANCED' },
            { id: 'skill_19', name: '文本格式化', command: '/format_text', category: 'ADVANCED' },
            { id: 'skill_20', name: '文本加密', command: '/encrypt_text', category: 'ADVANCED' }
        ];
    }

    // 渲染技能列表
    function renderSkills() {
        const textSkillsContainer = document.getElementById('textSkills');
        const codeSkillsContainer = document.getElementById('codeSkills');
        const advancedSkillsContainer = document.getElementById('advancedSkills');

        // 清空容器
        textSkillsContainer.innerHTML = '';
        codeSkillsContainer.innerHTML = '';
        advancedSkillsContainer.innerHTML = '';

        // 按类别分组
        allSkills.forEach(skill => {
            const skillItem = createSkillItem(skill);

            switch(skill.category) {
                case 'TEXT':
                    textSkillsContainer.appendChild(skillItem);
                    break;
                case 'CODE':
                    codeSkillsContainer.appendChild(skillItem);
                    break;
                case 'ADVANCED':
                    advancedSkillsContainer.appendChild(skillItem);
                    break;
                default:
                    textSkillsContainer.appendChild(skillItem);
            }
        });
    }

    // 创建技能项
    function createSkillItem(skill) {
        const skillItem = document.createElement('div');
        skillItem.className = 'skill-item';
        skillItem.textContent = skill.name;
        skillItem.dataset.skillId = skill.id;
        skillItem.dataset.command = skill.command;

        skillItem.addEventListener('click', () => {
            // if (!checkAuth()) return;
            selectSkill(skill);
        });

        return skillItem;
    }

    // 选择技能
    function selectSkill(skill) {
        // 移除之前选中的技能
        if (currentSkill) {
            const previousSkillItem = document.querySelector(`.skill-item[data-skill-id="${currentSkill.id}"]`);
            if (previousSkillItem) {
                previousSkillItem.classList.remove('active');
            }
        }

        // 设置当前技能
        currentSkill = skill;

        // 更新技能选择器按钮状态
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const currentSkillIndicator = document.getElementById('currentSkillIndicator');

        skillSelectorBtn.classList.add('active');
        if (currentSkillIndicator) {
            currentSkillIndicator.innerHTML = `当前技能: <span>${skill.name}</span>`;
        }

        // 更新技能项状态
        const skillItem = document.querySelector(`.skill-item[data-skill-id="${skill.id}"]`);
        if (skillItem) {
            skillItem.classList.add('active');
        }

        // 更新输入框提示
        const messageInput = document.getElementById('messageInput');
        messageInput.placeholder = `使用 ${skill.name} 技能，请输入内容...`;

        // 关闭技能选择菜单
        document.getElementById('skillSelectorMenu').classList.remove('show');

        console.log('已选择技能:', skill.name);
    }

    /**
     * 清除本地存储中的登录状态
     */
    function clearLoginStateFromStorage() {
        try {
            localStorage.removeItem(STORAGE_KEYS.AUTH_TOKEN);
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            console.log('已清除本地存储中的登录状态');
        } catch (error) {
            console.error('清除登录状态失败:', error);
        }
    }



    // 检查登录状态
    function checkLoginStatus() {
        const savedUser = localStorage.getItem('currentUser');
        const token = localStorage.getItem('token');

        if (savedUser && token) {
            currentUser = JSON.parse(savedUser);
            isLoggedIn = true;
            updateUserInterface();
        }
    }


    // ================= 页面加载完成后初始化 =================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('初始化聊天系统...');
        // // 1. 恢复登录状态（新增）
        // checkAndRestoreAuth();

        // 检查登录状态
        checkLoginStatus();

        loadSkills();
        // 1. 加载本地存储的聊天记录
        loadFromLocalStorage();
        // 2. 初始化聊天会话（无会话则创建新的）
        initChatSessions();
        // 3. 绑定所有交互事件（核心！确保按钮/输入框能响应）
        bindAllEvents();
        // 4. 控制台提示（方便调试）
        bindEvents();
        console.log('初始化完成，当前聊天会话：', chatSessions);
    });

</script>

</body>
</html>
