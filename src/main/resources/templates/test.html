<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片智能助手 - 技能选择</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-app {
            width: 1200px;
            height: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* 拖拽覆盖层 */
        .drag-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.1);
            border: 3px dashed #667eea;
            border-radius: 20px;
            z-index: 100;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #667eea;
            font-size: 24px;
            font-weight: 600;
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-overlay i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        /* 侧边栏 */
        .sidebar {
            width: 280px;
            background: #2d3748;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .user-profile {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #4a5568;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-status {
            font-size: 12px;
            color: #a0aec0;
        }

        .new-chat-btn {
            margin: 20px;
            padding: 15px;
            background: #4a5568;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            background: #5a6578;
        }

        .new-chat-btn i {
            margin-right: 10px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .history-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            border-left: 3px solid transparent;
            position: relative;
        }

        .history-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .history-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #4a5568;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .history-info {
            flex: 1;
            min-width: 0;
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;.....
        white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-preview {
            font-size: 12px;
            color: #a0aec0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-chat-btn {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: rgba(245, 101, 101, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .delete-chat-btn:hover {
            background: #f56565;
            transform: translateY(-50%) scale(1.1);
            opacity: 1;
        }

        /* 主聊天区域 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f7fafc;
        }

        .chat-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .chat-status {
            font-size: 13px;
            color: #718096;
        }

        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f7fafc;
        }

        .message {
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 15px;
        }

        .received .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .sent .message-avatar {
            background: #e2e8f0;
            color: #718096;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
        }

        .received .message-content {
            background: white;
            border-top-left-radius: 5px;
        }

        .sent .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-top-right-radius: 5px;
        }

        .message-text {
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            object-fit: cover;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        /* 输入区域 */
        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .upload-image-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #f7fafc;
            border: none;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .upload-image-btn:hover {
            background: #edf2f7;
            color: #4a5568;
        }

        .message-input-container {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 15px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            background: #f7fafc;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .image-input {
            display: none;
        }

        /* 图片缩略图样式 */
        .image-thumbnail {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .image-thumbnail:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-thumbnail .delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-thumbnail:hover .delete-btn {
            opacity: 1;
        }

        /* 底部操作区域 */
        .bottom-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 技能选择器 */
        .skill-selector {
            position: relative;
            display: inline-block;
        }

        .skill-selector-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .skill-selector-btn:hover {
            background: #e9ecef;
        }

        .skill-selector-btn.active {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        .skill-selector-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .skill-selector-menu.show {
            display: block;
        }

        .skill-category {
            padding: 10px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .skill-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            padding: 10px;
        }

        .skill-item {
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            text-align: center;
        }

        .skill-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .skill-item.active {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        .current-skill-indicator {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
            font-weight: normal;
        }

        .current-skill-indicator span {
            font-weight: 600;
            color: #1565c0;
        }

        .tool-actions {
            display: flex;
            gap: 5px;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            color: #a0aec0;
            margin-top: 50%;
            transform: translateY(-50%);
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-state .hint {
            font-size: 14px;
            opacity: 0.7;
        }

        /* 图片预览模态框 */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .image-preview-modal.active {
            display: flex;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            overflow: hidden;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        /* 处理指示器 */
        .processing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .processing-dots {
            display: flex;
            gap: 4px;
        }

        .processing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #667eea;
            animation: processing 1.5s infinite;
        }

        .processing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .processing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes processing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
<!-- 图片预览模态框 -->
<div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-content">
        <img id="previewImage" src="" alt="预览图片">
    </div>
</div>

<!-- 拖拽覆盖层 -->
<div class="drag-overlay" id="dragOverlay">
    <i class="fas fa-cloud-upload-alt"></i>
    <div>松开鼠标上传图片</div>
</div>

<div class="chat-app">
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="user-profile">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-name">用户</div>
            <div class="user-status">在线</div>
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i>
            <span>新建对话</span>
        </button>

        <div class="chat-history" id="chatHistory">
            <!-- 聊天历史会动态加载 -->
        </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chat-info">
                <div class="chat-name">豆包智能助手</div>
                <div class="chat-status">在线 · 选择一个技能开始对话</div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <p>开始与豆包对话吧！</p>
                <div class="hint">选择一个技能，然后输入您的内容</div>
            </div>
        </div>

        <div class="input-area">
            <!-- 图片缩略图容器 -->
            <div class="input-container">
                <div class="input-actions" id="inputActions">
                    <!-- 上传图片按钮 -->
                    <button class="upload-image-btn" id="uploadImageButton" title="上传图片">
                        <i class="fas fa-image"></i>
                    </button>
                    <!-- 图片缩略图会动态添加到这里 -->
                </div>

                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="请先选择一个技能，然后输入内容"></textarea>
                </div>

                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>

                <input type="file" id="imageInput" class="image-input" accept="image/*" multiple>
            </div>

            <!-- 底部操作区域 -->
            <div class="bottom-actions">
                <div class="skill-selector" id="skillSelector">
                    <button class="skill-selector-btn" id="skillSelectorBtn">
                        <i class="fas fa-magic"></i>
                        <span>选择技能</span>
                        <div class="current-skill-indicator" id="currentSkillIndicator"></div>
                    </button>
                    <div class="skill-selector-menu" id="skillSelectorMenu">
                        <div class="skill-category">文本处理</div>
                        <div class="skill-items" id="textSkills">
                            <!-- 文本处理技能会动态添加 -->
                        </div>

                        <div class="skill-category">代码相关</div>
                        <div class="skill-items" id="codeSkills">
                            <!-- 代码相关技能会动态添加 -->
                        </div>

                        <div class="skill-category">高级功能</div>
                        <div class="skill-items" id="advancedSkills">
                            <!-- 高级功能技能会动态添加 -->
                        </div>
                    </div>
                </div>

                <div class="tool-actions">
                    <button class="tool-btn" title="剪刀">
                        <i class="fas fa-cut"></i>
                    </button>
                    <button class="tool-btn" title="麦克风">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="tool-btn" title="发送">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 存储聊天数据
    let chatSessions = {};
    let currentChatId = null;
    let pendingImages = [];
    let currentSkill = null;
    let allSkills = [];
    let isProcessing = false;

    // 初始化应用
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
    });

    // 初始化应用
    async function initApp() {
        try {
            // 加载技能列表
            await loadSkills();

            // 加载聊天会话
            await loadChatSessions();

            // 绑定事件
            bindEvents();

            console.log('应用初始化完成');
        } catch (error) {
            console.error('应用初始化失败:', error);
            alert('应用初始化失败，请刷新页面重试');
        }
    }

    // 加载技能列表
    async function loadSkills() {
        try {
            const response = await fetch('api/skills');
            const data = await response.json();

            if (data.success) {
                allSkills = data.data;
                renderSkills();
                console.log('技能列表加载成功:', allSkills.length);
            } else {
                throw new Error(data.message || '获取技能列表失败');
            }
        } catch (error) {
            console.error('加载技能列表失败:', error);
            // 使用默认技能作为后备
            allSkills = getDefaultSkills();
            renderSkills();
        }
    }

    // 获取默认技能（后备方案）
    function getDefaultSkills() {
        return [
            { id: 'skill_1', name: '文本摘要', command: '/summarize', category: 'TEXT' },
            { id: 'skill_2', name: '英文翻译', command: '/translate_en', category: 'TEXT' },
            { id: 'skill_3', name: '中文翻译', command: '/translate_zh', category: 'TEXT' },
            { id: 'skill_4', name: '语法检查', command: '/grammar_check', category: 'TEXT' },
            { id: 'skill_5', name: '情感分析', command: '/sentiment_analysis', category: 'TEXT' },
            { id: 'skill_6', name: '关键词提取', command: '/extract_keywords', category: 'TEXT' },
            { id: 'skill_7', name: '文本分类', command: '/text_classification', category: 'TEXT' },
            { id: 'skill_8', name: '命名实体识别', command: '/ner', category: 'TEXT' },
            { id: 'skill_9', name: '文本纠错', command: '/text_correction', category: 'TEXT' },
            { id: 'skill_10', name: '文本生成', command: '/text_generation', category: 'TEXT' },
            { id: 'skill_11', name: '代码解释', command: '/explain_code', category: 'CODE' },
            { id: 'skill_12', name: '代码生成', command: '/generate_code', category: 'CODE' },
            { id: 'skill_13', name: '代码优化', command: '/optimize_code', category: 'CODE' },
            { id: 'skill_14', name: '代码调试', command: '/debug_code', category: 'CODE' },
            { id: 'skill_15', name: '问答系统', command: '/qa', category: 'ADVANCED' },
            { id: 'skill_16', name: '文本相似度', command: '/text_similarity', category: 'ADVANCED' },
            { id: 'skill_17', name: '文本聚类', command: '/text_clustering', category: 'ADVANCED' },
            { id: 'skill_18', name: '文本去重', command: '/deduplicate', category: 'ADVANCED' },
            { id: 'skill_19', name: '文本格式化', command: '/format_text', category: 'ADVANCED' },
            { id: 'skill_20', name: '文本加密', command: '/encrypt_text', category: 'ADVANCED' }
        ];
    }

    // 渲染技能列表
    function renderSkills() {
        const textSkillsContainer = document.getElementById('textSkills');
        const codeSkillsContainer = document.getElementById('codeSkills');
        const advancedSkillsContainer = document.getElementById('advancedSkills');

        // 清空容器
        textSkillsContainer.innerHTML = '';
        codeSkillsContainer.innerHTML = '';
        advancedSkillsContainer.innerHTML = '';

        // 按类别分组
        allSkills.forEach(skill => {
            const skillItem = createSkillItem(skill);

            switch(skill.category) {
                case 'TEXT':
                    textSkillsContainer.appendChild(skillItem);
                    break;
                case 'CODE':
                    codeSkillsContainer.appendChild(skillItem);
                    break;
                case 'ADVANCED':
                    advancedSkillsContainer.appendChild(skillItem);
                    break;
                default:
                    textSkillsContainer.appendChild(skillItem);
            }
        });
    }

    // 创建技能项
    function createSkillItem(skill) {
        const skillItem = document.createElement('div');
        skillItem.className = 'skill-item';
        skillItem.textContent = skill.name;
        skillItem.dataset.skillId = skill.id;
        skillItem.dataset.command = skill.command;

        skillItem.addEventListener('click', () => {
            selectSkill(skill);
        });

        return skillItem;
    }

    // 选择技能
    function selectSkill(skill) {
        // 移除之前选中的技能
        if (currentSkill) {
            const previousSkillItem = document.querySelector(`.skill-item[data-skill-id="${currentSkill.id}"]`);
            if (previousSkillItem) {
                previousSkillItem.classList.remove('active');
            }
        }

        // 设置当前技能
        currentSkill = skill;

        // 更新技能选择器按钮状态
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const currentSkillIndicator = document.getElementById('currentSkillIndicator');

        skillSelectorBtn.classList.add('active');
        if (currentSkillIndicator) {
            currentSkillIndicator.innerHTML = `当前技能: <span>${skill.name}</span>`;
        }

        // 更新技能项状态
        const skillItem = document.querySelector(`.skill-item[data-skill-id="${skill.id}"]`);
        if (skillItem) {
            skillItem.classList.add('active');
        }

        // 更新输入框提示
        const messageInput = document.getElementById('messageInput');
        messageInput.placeholder = `使用 ${skill.name} 技能，请输入内容...`;

        // 关闭技能选择菜单
        document.getElementById('skillSelectorMenu').classList.remove('show');

        console.log('已选择技能:', skill.name);
    }

    // 加载聊天会话
    async function loadChatSessions() {
        try {
            const response = await fetch('api/chat/sessions');
            const data = await response.json();

            if (data.success) {
                chatSessions = {};
                data.data.forEach(session => {
                    chatSessions[session.id] = session;
                });

                updateChatHistoryList();

                // 如果有会话，切换到最新的一个
                if (data.data.length > 0) {
                    const latestSession = data.data[0];
                    await switchToChat(latestSession.id);

                    // 恢复当前会话的技能状态
                    if (latestSession.currentSkillId) {
                        const skill = allSkills.find(s => s.id === latestSession.currentSkillId);
                        if (skill) {
                            selectSkill(skill);
                        }
                    }
                } else {
                    // 创建新会话
                    await createNewChat();
                }
            } else {
                throw new Error(data.message || '获取聊天会话失败');
            }
        } catch (error) {
            console.error('加载聊天会话失败:', error);
            await createNewChat();
        }
    }

    // 创建新聊天
    async function createNewChat() {
        try {
            const response = await fetch('api/chat/sessions', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                const session = data.data;
                chatSessions[session.id] = session;

                await switchToChat(session.id);
                updateChatHistoryList();

                // 重置技能状态
                resetCurrentSkill();

                return session.id;
            } else {
                throw new Error(data.message || '创建会话失败');
            }
        } catch (error) {
            console.error('创建新聊天失败:', error);
            return null;
        }
    }

    // 搜索聊天会话
    async function searchChatSessions(keyword) {
        try {
            const response = await fetch(`api/chat/sessions/search?keyword=${encodeURIComponent(keyword)}`);
            const data = await response.json();

            if (data.success) {
                return data.data;
            } else {
                throw new Error(data.message || '搜索会话失败');
            }
        } catch (error) {
            console.error('搜索聊天会话失败:', error);
            return [];
        }
    }

    // 切换到指定聊天
    async function switchToChat(chatId) {
        if (!chatSessions[chatId]) {
            console.error('聊天会话不存在:', chatId);
            return;
        }

        try {
            const response = await fetch(`api/chat/sessions/${chatId}`);
            const data = await response.json();

            if (data.success) {
                const chat = data.data;
                currentChatId = chat.id;

                // 更新聊天标题
                document.querySelector('.chat-name').textContent = chat.title;

                // 清空消息容器
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';

                // 添加消息到界面
                if (chat.messages && chat.messages.length > 0) {
                    chat.messages.forEach(message => {
                        addMessageToUI(message);
                    });
                } else {
                    // 显示空状态
                    showEmptyState();
                }

                // 恢复当前会话的技能状态
                if (chat.currentSkillId) {
                    const skill = allSkills.find(s => s.id === chat.currentSkillId);
                    if (skill) {
                        selectSkill(skill);
                    }
                }

                // 更新聊天历史列表的激活状态
                updateChatHistoryList();

                console.log('切换到聊天:', chatId);
            } else {
                throw new Error(data.message || '获取会话详情失败');
            }
        } catch (error) {
            console.error('切换聊天失败:', error);
            alert('切换聊天失败: ' + error.message);
        }
    }

    // 显示空状态
    function showEmptyState() {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = `
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <p>开始与豆包对话吧！</p>
                <div class="hint">选择一个技能，然后输入您的内容</div>
            </div>
        `;
    }

    // 更新聊天历史列表
    function updateChatHistoryList() {
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML = '';

        // 按更新时间倒序排序
        const sortedChats = Object.values(chatSessions).sort((a, b) => {
            return new Date(b.updatedAt) - new Date(a.updatedAt);
        });

        sortedChats.forEach(chat => {
            const historyItem = document.createElement('div');
            historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
            historyItem.dataset.chatId = chat.id;

            // 获取最后一条消息作为预览
            const lastMessage = chat.messages && chat.messages.length > 0 ?
                chat.messages[chat.messages.length - 1] : null;
            const previewText = lastMessage ?
                (lastMessage.content && lastMessage.content.length > 20 ?
                    lastMessage.content.substring(0, 20) + '...' : lastMessage.content) :
                '新对话';

            historyItem.innerHTML = `
                <div class="history-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="history-info">
                    <div class="history-title">${chat.title}</div>
                    <div class="history-preview">${previewText}</div>
                </div>
                <button class="delete-chat-btn" title="删除聊天">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // 点击聊天项切换聊天
            historyItem.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-chat-btn')) {
                    switchToChat(chat.id);
                }
            });

            // 删除聊天按钮
            const deleteBtn = historyItem.querySelector('.delete-chat-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            });

            chatHistory.appendChild(historyItem);
        });
    }

    // 删除聊天
    async function deleteChat(chatId) {
        if (Object.keys(chatSessions).length <= 1) {
            alert('至少需要保留一个聊天会话');
            return;
        }

        try {
            const response = await fetch(`api/chat/sessions/${chatId}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (data.success) {
                delete chatSessions[chatId];

                // 如果删除的是当前聊天，切换到另一个聊天
                if (chatId === currentChatId) {
                    const remainingChatIds = Object.keys(chatSessions);
                    if (remainingChatIds.length > 0) {
                        await switchToChat(remainingChatIds[0]);
                    } else {
                        await createNewChat();
                    }
                }

                updateChatHistoryList();
                console.log('删除聊天成功:', chatId);
            } else {
                throw new Error(data.message || '删除会话失败');
            }
        } catch (error) {
            console.error('删除聊天失败:', error);
            alert('删除聊天失败: ' + error.message);
        }
    }

    // 发送消息
    async function sendMessage() {
        if (isProcessing) {
            return; // 防止重复发送
        }

        const messageInput = document.getElementById('messageInput');
        const text = messageInput.value.trim();
        const sendButton = document.getElementById('sendButton');

        // 检查是否已选择技能
        if (!currentSkill) {
            alert('请先选择一个技能！');
            return;
        }

        if (text === '' && pendingImages.length === 0) {
            return;
        }

        isProcessing = true;
        sendButton.disabled = true;

        try {
            // 显示处理中指示器
            showProcessingIndicator();

            // 准备请求数据
            const requestData = {
                sessionId: currentChatId,
                content: text,
                skillId: currentSkill.id,
                imageUrls: pendingImages.map(img => img.data)
            };

            const response = await fetch('api/chat/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();

            if (data.success) {
                // 隐藏处理中指示器
                hideProcessingIndicator();

                // 清空输入框和图片
                messageInput.value = '';
                clearPendingImages();

                // 重新加载当前会话以获取最新消息
                await switchToChat(currentChatId);

                console.log('消息发送成功');
            } else {
                throw new Error(data.message || '发送消息失败');
            }
        } catch (error) {
            console.error('发送消息失败:', error);
            hideProcessingIndicator();
            alert('发送消息失败: ' + error.message);
        } finally {
            isProcessing = false;
            sendButton.disabled = false;
        }
    }

    // 显示处理中指示器
    function showProcessingIndicator() {
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');

        if (emptyState) {
            emptyState.remove();
        }

        const processingDiv = document.createElement('div');
        processingDiv.className = 'message received';
        processingDiv.id = 'processingIndicator';

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';

        const content = document.createElement('div');
        content.className = 'message-content';

        const processingText = document.createElement('div');
        processingText.className = 'message-text';
        processingText.innerHTML = `
            <div>正在使用 ${currentSkill.name} 技能处理您的请求...</div>
            <div class="processing-indicator">
                <div class="processing-dots">
                    <div class="processing-dot"></div>
                    <div class="processing-dot"></div>
                    <div class="processing-dot"></div>
                </div>
            </div>
        `;

        content.appendChild(processingText);
        processingDiv.appendChild(avatar);
        processingDiv.appendChild(content);
        messagesContainer.appendChild(processingDiv);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 隐藏处理中指示器
    function hideProcessingIndicator() {
        const processingIndicator = document.getElementById('processingIndicator');
        if (processingIndicator) {
            processingIndicator.remove();
        }
    }

    // 添加消息到UI
    function addMessageToUI(message) {
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');

        if (emptyState) {
            emptyState.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.type === 'USER' ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = message.id;

        // 消息头像
        const messageAvatar = document.createElement('div');
        messageAvatar.className = 'message-avatar';
        messageAvatar.innerHTML = message.type === 'USER' ?
            '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

        // 消息内容
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        // 文本内容
        if (message.content) {
            const messageText = document.createElement('div');
            messageText.className = 'message-text';

            // 检查是否是base64图片数据
            if (message.content.startsWith('data:image/')) {
                // 如果是图片数据，创建图片元素
                const img = document.createElement('img');
                img.src = message.content;
                img.alt = 'AI生成的图片';
                img.className = 'message-image';
                img.onclick = () => previewImage(message.content);
                messageText.appendChild(img);
            } else {
                // 如果是普通文本
                messageText.textContent = message.content;
            }
            messageContent.appendChild(messageText);
        }

        // 图片内容（原有的imageUrls处理）
        if (message.imageUrls && message.imageUrls.length > 0) {
            const messageImages = document.createElement('div');
            messageImages.className = 'message-images';

            message.imageUrls.forEach(imageUrl => {
                const img = document.createElement('img');

                // 检查是否是base64数据
                if (imageUrl.startsWith('data:image/')) {
                    img.src = imageUrl;
                } else {
                    // 如果是普通URL
                    img.src = imageUrl;
                }

                img.alt = '消息图片';
                img.className = 'message-image';
                img.onclick = () => previewImage(imageUrl);
                messageImages.appendChild(img);
            });

            messageContent.appendChild(messageImages);
        }

        // 消息时间
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        const timestamp = new Date(message.timestamp);
        messageTime.textContent = timestamp.toLocaleTimeString('zh-CN', {
            hour: '2-digit', minute: '2-digit'
        });
        messageContent.appendChild(messageTime);

        if (message.type === 'USER') {
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageAvatar);
        } else {
            messageDiv.appendChild(messageAvatar);
            messageDiv.appendChild(messageContent);
        }

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }


    // 重置当前技能
    function resetCurrentSkill() {
        currentSkill = null;

        // 更新技能选择器按钮状态
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const currentSkillIndicator = document.getElementById('currentSkillIndicator');

        skillSelectorBtn.classList.remove('active');
        if (currentSkillIndicator) {
            currentSkillIndicator.innerHTML = '';
        }

        // 移除所有技能项的激活状态
        document.querySelectorAll('.skill-item').forEach(item => {
            item.classList.remove('active');
        });

        // 更新输入框提示
        const messageInput = document.getElementById('messageInput');
        messageInput.placeholder = '请先选择一个技能，然后输入内容';
    }

    // 绑定事件
    function bindEvents() {
        // 新建聊天按钮
        document.getElementById('newChatBtn').addEventListener('click', createNewChat);

        // 发送按钮
        document.getElementById('sendButton').addEventListener('click', sendMessage);

        // 上传图片按钮
        document.getElementById('uploadImageButton').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        // 消息输入框回车发送
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 图片选择
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);

        // 技能选择器
        const skillSelectorBtn = document.getElementById('skillSelectorBtn');
        const skillSelectorMenu = document.getElementById('skillSelectorMenu');

        skillSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            skillSelectorMenu.classList.toggle('show');
        });

        // 点击页面其他区域关闭菜单
        document.addEventListener('click', () => {
            skillSelectorMenu.classList.remove('show');
        });

        // 阻止菜单内部点击事件冒泡
        skillSelectorMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 图片预览模态框点击关闭
        const imagePreviewModal = document.getElementById('imagePreviewModal');
        if (imagePreviewModal) {
            imagePreviewModal.addEventListener('click', function() {
                this.classList.remove('active');
            });
        }

        // 初始化拖拽功能
        initDragAndDrop();
    }

    // 初始化拖拽功能
    function initDragAndDrop() {
        const chatApp = document.querySelector('.chat-app');
        const dragOverlay = document.getElementById('dragOverlay');
        const messagesContainer = document.getElementById('messagesContainer');

        // 阻止默认拖拽行为
        const preventDefault = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        // 拖拽进入
        const handleDragEnter = (e) => {
            preventDefault(e);
            if (e.dataTransfer.types.includes('Files')) {
                dragOverlay.classList.add('active');
            }
        };

        // 拖拽离开
        const handleDragLeave = (e) => {
            preventDefault(e);
            if (!chatApp.contains(e.relatedTarget)) {
                dragOverlay.classList.remove('active');
            }
        };

        // 放置文件
        const handleDrop = (e) => {
            preventDefault(e);
            dragOverlay.classList.remove('active');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files);
            }
        };

        // 为整个聊天应用添加拖拽事件
        chatApp.addEventListener('dragenter', handleDragEnter);
        chatApp.addEventListener('dragover', preventDefault);
        chatApp.addEventListener('dragleave', handleDragLeave);
        chatApp.addEventListener('drop', handleDrop);

        // 为消息容器单独添加拖拽事件
        messagesContainer.addEventListener('dragenter', handleDragEnter);
        messagesContainer.addEventListener('dragover', preventDefault);
        messagesContainer.addEventListener('dragleave', handleDragLeave);
        messagesContainer.addEventListener('drop', handleDrop);
    }

    // 处理图片选择
    function handleImageSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFileSelect(files);
        }
    }

    // 处理文件选择
    function handleFileSelect(files) {
        for (let file of files) {
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                continue;
            }

            // 检查文件大小（限制为2MB）
            if (file.size > 2 * 1024 * 1024) {
                alert(`图片 ${file.name} 太大，请选择小于2MB的图片`);
                continue;
            }

            // 检查总图片数量限制
            if (pendingImages.length >= 5) {
                alert('最多只能上传5张图片');
                break;
            }

            addPendingImage(file);
        }
    }

    // 添加图片到待发送列表
    function addPendingImage(file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const imageData = {
                id: Date.now() + Math.random(),
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result
            };

            pendingImages.push(imageData);
            updateImageThumbnails();
        };

        reader.onerror = function(error) {
            console.error('读取图片文件失败:', error);
            alert('读取图片文件失败，请重试');
        };

        reader.readAsDataURL(file);
    }

    // 更新图片缩略图显示
    function updateImageThumbnails() {
        const inputActions = document.getElementById('inputActions');
        const uploadButton = document.getElementById('uploadImageButton');

        // 清空除上传按钮外的所有内容
        inputActions.innerHTML = '';
        if (uploadButton) {
            inputActions.appendChild(uploadButton);
        }

        // 为每张图片创建一个缩略图
        pendingImages.forEach((image, index) => {
            const thumbnail = createImageThumbnail(image, index);
            inputActions.appendChild(thumbnail);
        });
    }

    // 创建图片缩略图
    function createImageThumbnail(image, index) {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'image-thumbnail';
        thumbnail.title = image.name;
        thumbnail.dataset.imageId = image.id;

        const img = document.createElement('img');
        img.src = image.data;
        img.alt = image.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            removePendingImage(image.id);
        };

        thumbnail.appendChild(img);
        thumbnail.appendChild(deleteBtn);

        // 点击缩略图预览图片
        thumbnail.onclick = () => previewImage(image.data);

        return thumbnail;
    }

    // 移除待发送图片
    function removePendingImage(imageId) {
        pendingImages = pendingImages.filter(img => img.id !== imageId);
        updateImageThumbnails();
    }

    // 清空所有待发送图片
    function clearPendingImages() {
        pendingImages = [];
        updateImageThumbnails();
    }

    // 预览图片
    function previewImage(imageSrc) {
        const modal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');

        if (modal && previewImage) {
            previewImage.src = imageSrc;
            modal.classList.add('active');
        }
    }
</script>
</body>
</html>